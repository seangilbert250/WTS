<%@ Page Language="C#" AutoEventWireup="true" CodeFile="AOR_Edit.aspx.cs" Inherits="AOR_Edit" MasterPageFile="~/EditTabs.master" Theme="Default" %>

<asp:Content ID="cpHeadTitle" ContentPlaceHolderID="headTitle" runat="Server">AOR</asp:Content>
<asp:Content ID="cpHead" ContentPlaceHolderID="head" runat="Server">
	<!-- Copyright (c) 2017 Infinite Technologies, Inc. -->
</asp:Content>
<asp:Content ID="cpHeaderImage" ContentPlaceHolderID="ContentPlaceHolderHeaderImage" runat="Server">
	<img id="imgSettings" src="Images/Icons/cog.png" title="Grid Settings" alt="Grid Settings" width="15" height="15" style="cursor: pointer; margin-left: 4px;" />
	<img src="Images/Icons/pencil.png" alt="Details" width="15" height="15" />
	<asp:HiddenField ID="itisettings" runat="server" EnableViewState="True" />
</asp:Content>
<asp:Content ID="cpHeaderText" ContentPlaceHolderID="ContentPlaceHolderHeaderText" runat="Server">Details</asp:Content>
<asp:Content ID="cpHeaderButtons" ContentPlaceHolderID="ContentPlaceHolderHeaderButtons" runat="Server">
	<input type="button" id="btnCancel" value="Cancel" style="vertical-align: middle; display: none;" />
	<input type="button" id="btnSave" value="Save" disabled="disabled" style="vertical-align: middle; display: none;" />
</asp:Content>
<asp:Content ID="cpBody" ContentPlaceHolderID="ContentPlaceHolderBody" runat="Server">
	<div id="divPageContainer" style="overflow-x: hidden; overflow-y: auto;">
		<div id="divAOR" style="padding: 10px;">
			<table style="width: 100%;">
				<tr>
					<td style="width: 5px;">
						&nbsp;
					</td>
					<td style="width: 95px;">
						AOR #:
					</td>
					<td>
						<span id="spnAOR" runat="server">-</span>
                        <div id="divInfo" style="float: right; display: none;"><span id="spnCreated" runat="server"></span><span id="spnUpdated" runat="server" style="padding-left: 30px;"></span></div>
					</td>
					<td style="width: 5px;">
						&nbsp;
					</td>
				</tr>
				<tr>
					<td>
						<span style="color: red;">*</span>
					</td>
					<td>
						AOR Name:
					</td>
					<td>
						<asp:TextBox ID="txtAORName" runat="server" MaxLength="150" Width="100%" ReadOnly="true" ForeColor="Gray"></asp:TextBox>
					</td>
					<td>
						&nbsp;
					</td>
				</tr>
				<tr>
					<td>
						&nbsp;
					</td>
					<td style="vertical-align: top;">
						Description:
					</td>
					<td>
						<asp:TextBox ID="txtDescription" runat="server" TextMode="MultiLine" Rows="4" MaxLength="500" Width="100%" ReadOnly="true" ForeColor="Gray"></asp:TextBox>
					</td>
					<td>
						&nbsp;
					</td>
				</tr>
				<tr>
					<td>
						&nbsp;
					</td>
					<td style="vertical-align: top;">
						Notes:
					</td>
					<td>
						<asp:TextBox ID="txtNotes" runat="server" TextMode="MultiLine" Rows="4" Width="100%" ReadOnly="true" ForeColor="Gray"></asp:TextBox>
					</td>
					<td>
						&nbsp;
					</td>
				</tr>
                <tr>
					<td>
						&nbsp;
					</td>
					<td style="vertical-align: top;">
						Approved:
					</td>
					<td>
						<asp:CheckBox ID="chkApproved" runat="server" Enabled="false" />&nbsp;&nbsp;
                        <asp:Label ID="lblApprovedBy" runat="server"></asp:Label>&nbsp;&nbsp;
                        <asp:Label ID="lblApprovedDate" runat="server"></asp:Label>
					</td>
					<td>
						&nbsp;
					</td>
				</tr>
				<tr>
					<td colspan="4" style="padding-top: 10px;">
						<table style="border-collapse: collapse;">
                            <tr class="gridHeader">
                                <th colspan="3" style="border-left: 1px solid grey;">
                                    Estimated Effort
                                </th>
                            </tr>
                            <tr class="gridHeader">
                                <th style="border-left: 1px solid grey; width: 155px;">
                                    Coding
                                </th>
                                <th style="width: 155px;">
                                    Testing
                                </th>
                                <th style="width: 155px;">
                                    Training/Support
                                </th>
                            </tr>
                            <tr class="gridBody">
                                <td style="border-left: 1px solid grey; text-align: center;">
                                    <asp:DropDownList ID="ddlCodingEffort" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                </td>
                                <td style="text-align: center;">
                                    <asp:DropDownList ID="ddlTestingEffort" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                </td>
                                <td style="text-align: center;">
                                    <asp:DropDownList ID="ddlTrainingSupportEffort" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                </td>
                            </tr>
						</table>
					</td>
				</tr>
			</table>
		</div>
		<div id="iti_sections">
			<div id="divReleaseContainer" data-index="1">
				<div class="pageContentHeader" style="vertical-align: top; padding: 5px;">
					<img class="toggleSection" src="Images/Icons/minus_blue.png" title="Hide Section" alt="Hide Section" height="12" width="12" data-section="Release" style="cursor: pointer;" />&nbsp;&nbsp;Release:
				</div>
				<div id="divRelease" style="padding: 10px;">
					<table style="width: 100%;">
                        <tr>
                            <td style="padding-bottom: 10px;">
                                <table style="border-collapse: collapse;">
                                    <tr class="gridHeader">
                                        <th style="border-left: 1px solid grey; width: 100px;">
                                            Stage Priority
                                        </th>
                                        <th style="width: 155px;">
                                            Current Release
                                        </th>
                                        <th style="width: 155px;">
                                            Release Status
                                        </th>
                                        <th style="width: 155px;">
                                            Production Status
                                        </th>
                                        <th style="width: 100px;">
                                            Tier
                                        </th>
                                        <th style="width: 100px;">
                                            Rank
                                        </th>
                                        <th style="width: 100px;">
                                            IP1
                                        </th>
                                        <th style="width: 100px;">
                                            IP2
                                        </th>
                                        <th style="width: 100px;">
                                            IP3
                                        </th>
                                    </tr>
                                    <tr class="gridBody">
                                        <td style="border-left: 1px solid grey; text-align: center;">
                                            <asp:DropDownList ID="ddlStagePriority" runat="server" Width="95%" Enabled="false">
									            <asp:ListItem Value="0" Text=""></asp:ListItem>
									            <asp:ListItem Value="1" Text="1"></asp:ListItem>
									            <asp:ListItem Value="2" Text="2"></asp:ListItem>
									            <asp:ListItem Value="3" Text="3"></asp:ListItem>
									            <asp:ListItem Value="4" Text="4"></asp:ListItem>
								            </asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlProductVersion" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <span id="spnStatus" runat="server"></span>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlReleaseProduction" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlTier" runat="server" Width="95%" Enabled="false">
                                                <asp:ListItem Value="0" Text=""></asp:ListItem>
                                                <asp:ListItem Value="1" Text="A"></asp:ListItem>
                                                <asp:ListItem Value="2" Text="B"></asp:ListItem>
                                                <asp:ListItem Value="3" Text="C"></asp:ListItem>
                                            </asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:TextBox ID="txtRank" runat="server" MaxLength="2" Width="95%" ReadOnly="true" ForeColor="Gray" style="text-align: center;"></asp:TextBox>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlIP1" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlIP2" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlIP3" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
						<tr>
                            <td style="padding-bottom: 10px;">
                                <table style="border-collapse: collapse; width: 100%;">
                                    <tr class="gridHeader">
                                        <th style="border-left: 1px solid grey;">
                                            ROI
                                        </th>
                                    </tr>
                                    <tr class="gridBody">
                                        <td style="border-left: 1px solid grey; text-align: center;">
                                            <asp:TextBox ID="txtROI" runat="server" TextMode="MultiLine" Rows="4" Width="99%" ReadOnly="true" ForeColor="Gray"></asp:TextBox>
                                        </td>
                                    </tr>
                                </table>
                            </td>
						</tr>
						<tr>
							<td style="padding-bottom: 10px;">
								<table style="border-collapse: collapse;">
                                    <tr class="gridHeader">
                                        <th style="border-left: 1px solid grey; width: 155px;">
                                            CMMI
                                        </th>
                                        <th style="width: 155px;">
                                            Critical Path Team
                                        </th>
                                        <th style="width: 165px;">
                                            Work Type
                                        </th>
                                        <th style="width: 130px;">
                                            Customer Flagship
                                        </th>
                                        <th style="width: 155px;">
                                            Cyber Review
                                        </th>
                                        <th id="thCyberNarrative" style="width: 400px; display: none;">
                                            <span style="color: red;">*</span>&nbsp;Cyber Review Narrative
                                        </th>
                                    </tr>
                                    <tr class="gridBody">
                                        <td style="border-left: 1px solid grey; text-align: center;">
                                            <asp:DropDownList ID="ddlCMMI" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlCriticalPathTeam" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlWorkType" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center; background-color: #F5F6CE;">
                                            <asp:CheckBox ID="chkAORCustomerFlagship" runat="server" Enabled="false" />
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlCyber" runat="server" Width="95%" Enabled="false">
									            <asp:ListItem Value="-1" Text=""></asp:ListItem>
									            <asp:ListItem Value="0" Text="Reviewed/No Risk"></asp:ListItem>
									            <asp:ListItem Value="1" Text="Reviewed/Concern"></asp:ListItem>
                                                <asp:ListItem Value="2" Text="Not Required"></asp:ListItem>
								            </asp:DropDownList>
                                        </td>
                                        <td id="tdCyberNarrative" style="text-align: center; display: none;">
                                            <asp:TextBox ID="txtCyberNarrative" runat="server" TextMode="MultiLine" Rows="2" Width="99%" ReadOnly="true" ForeColor="Gray"></asp:TextBox>
                                        </td>
                                    </tr>
								</table>
							</td>
						</tr>
                        <tr>
							<td>
								<table style="border-collapse: collapse;">
                                    <tr class="gridHeader">
                                        <th colspan="7" style="border-left: 1px solid grey;">
                                            Status
                                        </th>
                                    </tr>
                                    <tr class="gridHeader">
                                        <th style="border-left: 1px solid grey; width: 155px;">
                                            Investigation (Inv)
                                        </th>
                                        <th style="width: 155px;">
                                            Technical (TD)
                                        </th>
                                        <th style="width: 155px;">
                                            Customer Design (CD)
                                        </th>
                                        <th style="width: 155px;">
                                            Coding (C)
                                        </th>
                                        <th style="width: 155px;">
                                            Internal Testing (IT)
                                        </th>
                                        <th style="width: 215px;">
                                            Customer Validation Testing (CVT)
                                        </th>
                                        <th style="width: 155px;">
                                            Adoption (Adopt)
                                        </th>
                                    </tr>
                                    <tr class="gridBody">
                                        <td style="border-left: 1px solid grey; text-align: center;">
                                            <asp:DropDownList ID="ddlInvestigation" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlTechnical" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlCustomerDesign" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlCoding" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlInternalTesting" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlCustomerVerificationTesting" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                        <td style="text-align: center;">
                                            <asp:DropDownList ID="ddlAdoption" runat="server" Width="95%" Enabled="false"></asp:DropDownList>
                                        </td>
                                    </tr>
								</table>
							</td>
						</tr>
					</table>
				</div>
			</div>
            <div id="divSystemsContainer" data-index="2">
				<div class="pageContentHeader" style="vertical-align: top; padding: 5px;">
					<img class="toggleSection" src="Images/Icons/minus_blue.png" title="Hide Section" alt="Hide Section" height="12" width="12" data-section="Systems" style="cursor: pointer;" />&nbsp;&nbsp;Systems:
				</div>
				<div id="divSystems" style="padding: 10px;">
					<table style="width: 100%;">
						<tr>
							<td>
								<div id="divAORSystems" runat="server"></div>
							</td>
						</tr>
					</table>
				</div>
			</div>
			<div id="divResourcesContainer" data-index="2">
				<div class="pageContentHeader" style="vertical-align: top; padding: 5px;">
					<img class="toggleSection" src="Images/Icons/minus_blue.png" title="Hide Section" alt="Hide Section" height="12" width="12" data-section="Resources" style="cursor: pointer;" />&nbsp;&nbsp;Resources:
				</div>
				<div id="divResources" style="padding: 10px;">
					<table style="width: 100%;">
						<tr>
							<td>
								<div id="divAORResources" runat="server"></div>
							</td>
						</tr>
					</table>
				</div>
			</div>
			<div id="divHistoryContainer" style="display: none;">
				<div class="pageContentHeader" style="vertical-align: top; padding: 5px;">
					<img class="toggleSection" src="Images/Icons/add_blue.png" title="Show Section" alt="Show Section" height="12" width="12" data-section="History" style="cursor: pointer;" />&nbsp;&nbsp;History:
				</div>
				<div id="divHistory" style="padding: 10px; display: none;">
					<table style="width: 100%;">
						<tr>
							<td>
								<div id="divAORHistory" runat="server"></div>
							</td>
						</tr>
					</table>
				</div>
			</div>
		</div>
	</div>
	<asp:ScriptManager ID="scriptManager1" runat="server" EnablePageMethods="true"></asp:ScriptManager>
	<script id="jsVariables" type="text/javascript">
		var _pageUrls;
	</script>

	<script id="jsEvents" type="text/javascript">
	    $.extend({ icompare: function(a, b) {
	        return $(a).not(b).get().length === 0 && $(b).not(a).get().length === 0;
	    }});

		function imgRefresh_click() {
			refreshPage();
		}

		function imgSettings_click() {
			openSettings();
		}

		function btnCancel_click() {
			refreshPage();
		}

		function btnSave_click() {
			try {
				var validation = validate();

	            if (validation.length === 0) {
					ShowDimmer(true, 'Saving...', 1);
					
					var arrSystems = [], arrResources = [];

                    $('#<%=this.divAORSystems.ClientID %> tr').not(':first').each(function() {
						var $obj = $(this);

	                    if ($obj.find('td').text().indexOf('No Systems') === -1) arrSystems.push({ 'systemid': $obj.find('select[field="System"]').val(), 'primary': ($obj.find('input[field="Primary"]').is(':checked') ? 1 : 0) });
					});

					$('#<%=this.divAORResources.ClientID %> tr').not(':first').each(function() {
						var $obj = $(this);

	                    if ($obj.find('td').text().indexOf('No Resources') === -1) arrResources.push({ 'resourceid': $obj.find('select[field="Resource"]').val(), 'allocation': $obj.find('input[field="Allocation"]').val() });
					});

				    var nSystemsJSON = '{save:' + JSON.stringify(arrSystems) + '}';
					var nResourcesJSON = '{save:' + JSON.stringify(arrResources) + '}';
					
					PageMethods.Save('<%=this.NewAOR %>', '<%=this.AORID %>', $('#<%=this.txtAORName.ClientID %>').val(), $('#<%=this.txtDescription.ClientID %>').val(), $('#<%=this.txtNotes.ClientID %>').val(), 
						($('#<%=this.chkApproved.ClientID %>').is(':checked') ? 1 : 0), $('#<%=this.ddlCodingEffort.ClientID %>').val(), $('#<%=this.ddlTestingEffort.ClientID %>').val(), $('#<%=this.ddlTrainingSupportEffort.ClientID %>').val(),
                        $('#<%=this.ddlStagePriority.ClientID %>').val(), $('#<%=this.ddlProductVersion.ClientID %>').val(), $('#<%=this.ddlReleaseProduction.ClientID %>').val(),
						$('#<%=this.ddlTier.ClientID %>').val(), $('#<%=this.txtRank.ClientID %>').val(), $('#<%=this.ddlIP1.ClientID %>').val(), $('#<%=this.ddlIP2.ClientID %>').val(), $('#<%=this.ddlIP3.ClientID %>').val(),
                        $('#<%=this.txtROI.ClientID %>').val(), $('#<%=this.ddlCMMI.ClientID %>').val(), $('#<%=this.ddlCyber.ClientID %>').val(), $('#<%=this.txtCyberNarrative.ClientID %>').val(),
                        $('#<%=this.ddlCriticalPathTeam.ClientID %>').val(), $('#<%=this.ddlWorkType.ClientID %>').val(), ($('#<%=this.chkAORCustomerFlagship.ClientID %>').is(':checked') ? 1 : 0),
                        $('#<%=this.ddlInvestigation.ClientID %>').val(), $('#<%=this.ddlTechnical.ClientID %>').val(), $('#<%=this.ddlCustomerDesign.ClientID %>').val(), $('#<%=this.ddlCoding.ClientID %>').val(),
                        $('#<%=this.ddlInternalTesting.ClientID %>').val(), $('#<%=this.ddlCustomerVerificationTesting.ClientID %>').val(), $('#<%=this.ddlAdoption.ClientID %>').val(),
                        nSystemsJSON, nResourcesJSON, save_done, on_error);
				}
				else {
					MessageBox('Invalid entries: <br><br>' + validation);
				}
			}
			catch (e) {
				ShowDimmer(false);
				MessageBox('An error has occurred.');
			}
		}

		function save_done(result) {
			ShowDimmer(false);

			var blnSaved = false, blnExists = false;
			var newID = '', errorMsg = '';
			var obj = $.parseJSON(result);

			if (obj) {
				if (obj.saved && obj.saved.toUpperCase() == 'TRUE') blnSaved = true;
				if (obj.exists && obj.exists.toUpperCase() == 'TRUE') blnExists = true;
				if (obj.newID && parseInt(obj.newID) > 0) newID = obj.newID;
				if (obj.error) errorMsg = obj.error;
			}

			if (blnSaved) {
				if (parent.parent._newItemCreated != undefined) parent.parent._newItemCreated = true;

				MessageBox('AOR has been saved.');

				if (($('#<%=this.ddlProductVersion.ClientID %>').val() != '<%=this.ddlProductVersion.SelectedValue %>' || $('#<%=this.txtAORName.ClientID %>').val() != $('#<%=this.txtAORName.ClientID %>').attr('original_value')) && parent.refreshPage) {
				    parent.refreshPage(newID);
				}
				else {
				    refreshPage(newID);
				}
			}
			else if (blnExists) {
				MessageBox('AOR Name already exists.');
			}
			else {
				MessageBox('Failed to save. <br>' + errorMsg);
			}
		}

		function on_error() {
			ShowDimmer(false);
			MessageBox('An error has occurred.');
		}

		function imgToggleSection_click(obj) {
			var $obj = $(obj);
			var section = $obj.data('section');

			if ($obj.attr('title') == 'Show Section') {
				$obj.attr('src', 'Images/Icons/minus_blue.png');
				$obj.attr('title', 'Hide Section');
				$obj.attr('alt', 'Hide Section');
				$('#div' + section).show();
			}
			else {
				$obj.attr('src', 'Images/Icons/add_blue.png');
				$obj.attr('title', 'Show Section');
				$obj.attr('alt', 'Show Section');
				$('#div' + section).hide();
			}
		}

		function ddlCyber_change() {
		    setupCyber(false);
		}

	    function setupCyber(init) {
	        var selected = $('#<%=this.ddlCyber.ClientID %> option:selected').text();

		    if (selected == 'Reviewed/Concern' || selected == 'Not Required') {
		        if (selected == 'Not Required') {
		            if (!init) $('#<%=this.txtCyberNarrative.ClientID %>').val('This workload does not deal with changes to the code and does not impact changes to the UI.');
                    $('#<%=this.txtCyberNarrative.ClientID %>').css('color', 'gray');
		            $('#<%=this.txtCyberNarrative.ClientID %>').attr('readonly', 'true');
		        }
		        else {
		            $('#<%=this.txtCyberNarrative.ClientID %>').removeAttr('readonly');
                    $('#<%=this.txtCyberNarrative.ClientID %>').css('color', 'black');
		            if (!init) $('#<%=this.txtCyberNarrative.ClientID %>').empty();
		        }

		        $('#thCyberNarrative').show();
		        $('#tdCyberNarrative').show();
		    }
		    else {
		        $('#thCyberNarrative').hide();
		        $('#tdCyberNarrative').hide();
		        $('#<%=this.txtCyberNarrative.ClientID %>').removeAttr('readonly');
                $('#<%=this.txtCyberNarrative.ClientID %>').css('color', 'black');
		        if (!init) $('#<%=this.txtCyberNarrative.ClientID %>').empty();
		    }
	    }

		function openSettings() {
			if (parent.openSettings) {
				parent.openSettings();
				return;
			}

			var nTitle = 'ITI Settings';
			var nHeight = 355, nWidth = 525;
			var nURL = 'ITI_Settings.aspx?GridView=AOR&ActiveTab=0';
			var openPopup = popupManager.AddPopupWindow('ITI_Settings', nTitle, 'Loading.aspx?Page=' + nURL, nHeight, nWidth, 'PopupWindow', this);

			if (openPopup) openPopup.Open();
		}

		function reorderSectionList() {
			var items = $('#iti_sections').children();
			var data = JSON.parse($(defaultParentPage.itisettings).text());
            var newArray = [];
	        var oldArray = [];

	        $.each(items, function (i, v) {
	            newArray.push('' + v.id.replace("div", "chk").replace("Container", ""));
            });

            $.each(data.sectionexpanded, function (i, v) {
	            oldArray.push(i);
	        });

            if (!$.icompare(newArray, oldArray)) {
	            var newSectionOrder = [];
	            var newSectionExpanded = {};

                $.each(items, function (i, v) {
                    var newItem = i + 1;
                    newSectionOrder.push(newItem.toString());
                    newSectionExpanded['' + v.id.replace("div","chk").replace("Container","") + ''] = true;
                });

	            data.sectionorder = newSectionOrder;
                data.sectionexpanded = newSectionExpanded;
	            $(defaultParentPage.itisettings).text(JSON.stringify(data));
	        }

			var orderedItems = $.map(data.sectionorder, function (value) {
				return items.get(value - 1);
			});

			$('#iti_sections').empty().html(orderedItems);
		}

	    function showSectionList() {
			var data = JSON.parse($(defaultParentPage.itisettings).text());
			var imgArray = $('#iti_sections').find('img');

			$.each(data.sectionexpanded, function (i, item) {
				$.each(imgArray, function (j, value) {
					var $obj = $(imgArray[j]);
					var section = $obj.data('section');

					if (section === i.substring(3)) {
						if (item === false) {
							$obj.attr("src", "Images/Icons/minus_blue.png");
							$obj.attr("title", "Hide Section");
							$obj.attr("alt", "Hide Section");
							$obj.data("section", i.substring(3));
						} else {
							$obj.attr("src", "Images/Icons/add_blue.png");
							$obj.attr("title", "Show Section");
							$obj.attr("alt", "Show Section");
							$obj.data("section", i.substring(3));
						}
						imgToggleSection_click($obj);
					}
				});
			});
		}

		function validate() {
		    var validation = [];
            var $systemRows = $('#<%=this.divAORSystems.ClientID %> tr').not(':first');
			var $resourceRows = $('#<%=this.divAORResources.ClientID %> tr').not(':first');
			var blnExit = false;
			var allocationSum = 0;

			if ($('#<%=this.txtAORName.ClientID %>').val().length == 0) validation.push('AOR Name cannot be empty.');

		    if ($('#<%=this.ddlCyber.ClientID %> option:selected').text() == 'Reviewed/Concern' && $('#<%=this.txtCyberNarrative.ClientID %>').val().length == 0) validation.push('Cyber Review Narrative cannot be empty.');

		    $.each($systemRows, function () {
		        if (blnExit) return false;

		        var systemID = $(this).find('select[field="System"]').val();

		        $.each($systemRows.not($(this)), function () {
		            if ($(this).find('select[field="System"]').val() == systemID) {
		                validation.push('System cannot have duplicates.');
		                blnExit = true;
		                return false;
		            }
		        });
		    });

		    if ($systemRows.find('input[field="Primary"]:checked').length > 1) validation.push('Only one system can be flagged as primary.');

		    if ($systemRows.length > 0 && $systemRows.find('td').text().indexOf('No Systems') == -1) {
			    if ($systemRows.length == 1) {
                    $systemRows.find('input[field="Primary"]').prop('checked', true);
			    }

			    if ($systemRows.find('input[field="Primary"]:checked').length == 0) {
			        validation.push('Please check primary for a system.');
			    }
			}

		    blnExit = false;
		    $.each($resourceRows, function () {
				if (blnExit) return false;

				var resourceID = $(this).find('select[field="Resource"]').val();

				$.each($resourceRows.not($(this)), function () {
					if ($(this).find('select[field="Resource"]').val() == resourceID) {
						validation.push('Resource cannot have duplicates.');
						blnExit = true;
						return false;
					}
				});
			});

			$.each($('input[field="Allocation"]'), function () {
				allocationSum += parseInt($(this).val());
			});

			if (allocationSum > 100) validation.push('Total Allocation % cannot exceed 100.');

			return validation.join('<br>');
		}

        function addSystem() {
			var nHTML = '';
			var $tbl = $('#<%=this.divAORSystems.ClientID %> table');

			if ($tbl.find('td').text().indexOf('No Systems') != -1) $tbl.find('tr').not(':first').remove();

			nHTML += '<tr class=\"gridBody\" rowChanged="1"><td style=\"border-left: 1px solid grey; text-align: center;\">';
			nHTML += '<a href=\"\" onclick=\"removeSystem(this); return false;\" style=\"color: blue;\">Remove</a>';
			nHTML += '</td><td style=\"text-align: center;\">';
			nHTML += '<select field="System" original_value="0" fieldChanged="1" style="width: 95%; background-color: #F5F6CE;">' + decodeURIComponent('<%=this.SystemOptions %>') + '</select>';
            nHTML += '</td><td style=\"text-align: center; background-color: #F5F6CE;\">';
			nHTML += '<input type="checkbox" field="Primary" original_value="0" fieldChanged="1" style="width: 95%; text-align: center;" />';
			nHTML += '</td></tr>';

			$tbl.find('tr:first').after(nHTML);
			$('#btnSave').prop('disabled', false);
		}

		function removeSystem(obj) {
			$(obj).closest('tr').remove();

			var $tbl = $('#<%=this.divAORSystems.ClientID %> table');

			if ($tbl.find('tr').not(':first').length == 0) $tbl.append('<tr class="gridBody"><td colspan="3" style="border-top: 1px solid grey; border-left: 1px solid grey; text-align: center;">No Systems</td></tr>');

			$('#btnSave').prop('disabled', false);
		}

		function addResource() {
			var nHTML = '';
			var $tbl = $('#<%=this.divAORResources.ClientID %> table');

			if ($tbl.find('td').text().indexOf('No Resources') != -1) $tbl.find('tr').not(':first').remove();

			nHTML += '<tr class=\"gridBody\" rowChanged="1"><td style=\"border-left: 1px solid grey; text-align: center;\">';
			nHTML += '<a href=\"\" onclick=\"removeResource(this); return false;\" style=\"color: blue;\">Remove</a>';
			nHTML += '</td><td style=\"text-align: center;\">';
			nHTML += '<select field="Resource" original_value="0" fieldChanged="1" style="width: 95%; background-color: #F5F6CE;">' + decodeURIComponent('<%=this.UsersOptions %>') + '</select>';
			nHTML += '</td><td style=\"text-align: center;\">';
			nHTML += '<input type="text" value="0" maxlength="3" field="Allocation" original_value="0" fieldChanged="1" style="width: 95%; text-align: center;" />';
			nHTML += '</td></tr>';

			$tbl.find('tr:first').after(nHTML);
			$('#btnSave').prop('disabled', false);
		}

		function removeResource(obj) {
			$(obj).closest('tr').remove();

			var $tbl = $('#<%=this.divAORResources.ClientID %> table');

			if ($tbl.find('tr').not(':first').length == 0) $tbl.append('<tr class="gridBody"><td colspan="3" style="border-top: 1px solid grey; border-left: 1px solid grey; text-align: center;">No Resources</td></tr>');

			$('#btnSave').prop('disabled', false);
		}

		function input_change(obj) {
			var $obj = $(obj);
			
			if ($obj.attr('id') && $obj.attr('id').indexOf('Rank') != -1) {
			    var nVal = $obj.val();

			    $obj.val(nVal.replace(/[^\d]/g, ''));
			}

			switch ($obj.attr('field')) {
			    case 'System':
                case 'Primary':
				case 'Resource':
				case 'Allocation':
					$obj.attr('fieldChanged', '1');
					$obj.closest('tr').attr('rowChanged', '1');
					break;
			}

			if ($obj.attr('field') == 'Allocation') {
				var nVal = $obj.val();

				$obj.val(nVal.replace(/[^\d]/g, ''));
			}

			$('#btnSave').prop('disabled', false);
		}

		function txtBox_blur(obj) {
			var $obj = $(obj);
			var nVal = $obj.val();

			if ($obj.attr('id') && $obj.attr('id').indexOf('Rank') != -1) {
			    if (nVal.length == 1) $obj.val('0' + nVal);
			    return;
			}

			if ($obj.attr('field') == 'Allocation') {
				if (nVal == '') $obj.val('0');
				return;
			}

			$obj.val($.trim(nVal));
		}

		function refreshPage(newID) {
			var nURL = window.location.href;

			if (newID != undefined && parseInt(newID) > 0) {
				if (parent.refreshPage) parent.refreshPage(newID);
			}

			window.location.href = 'Loading.aspx?Page=' + nURL;
		}

		function resizePage() {
			resizePageElement('divPageContainer');
		}
	</script>

	<script id="jsInit" type="text/javascript">
		function initVariables() {
			_pageUrls = new PageURLs();
		}

		function initDisplay() {
			if ('<%=this.CanEditAOR %>'.toUpperCase() == 'TRUE') {
				$('input[type="text"], textarea').css('color', 'black');
				$('input[type="text"], textarea').removeAttr('readonly');
				$('select, input[type="checkbox"]').not('#<%=this.ddlProductVersion.ClientID %>').removeAttr('disabled');
				$('#btnCancel').show();
				$('#btnSave').show();
			}

		    if ('<%=this.NewAOR %>'.toUpperCase() == 'FALSE') {
		        $('#divInfo').show();
				$('#trReleaseStatus').show();
				$('#divHistoryContainer').show();
			}

			resizePage();
		}

		function initEvents() {
			$('#imgRefresh').click(function () { imgRefresh_click(); });
			$('#imgSettings').click(function () { imgSettings_click(); });
			$('#btnCancel').click(function () { btnCancel_click(); return false; });
			$('#btnSave').click(function () { btnSave_click(); return false; });
			$('.toggleSection').on('click', function () { imgToggleSection_click(this); });
            $('#<%=this.ddlCyber.ClientID %>').change(function () { ddlCyber_change(); return false; });
			$('input[type="text"], textarea').on('keyup paste', function () { input_change(this); });
			$('select, input[type="checkbox"]').on('change', function () { input_change(this); });
			$('input[type="text"], textarea').on('blur', function () { txtBox_blur(this); });
			$(window).resize(resizePage);
		}

		$(document).ready(function () {
	        if($(defaultParentPage.itisettings).text() === "") $(defaultParentPage.itisettings).text($("#<%=itisettings.ClientID %>").val());
			reorderSectionList();
	        showSectionList();
			initVariables();
			initDisplay();
			initEvents();

			setupCyber(true);
		});
	</script>
</asp:Content>