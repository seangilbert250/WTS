<%@ Page Language="C#" AutoEventWireup="true" CodeFile="MassChange_Wizard.aspx.cs" Inherits="MassChange_Wizard" Theme="Default" %>

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <!-- Copyright (c) 2017 Infinite Technologies, Inc. -->
	<title>AOR Wizard</title>
	<script type="text/javascript" src="Scripts/shell.js"></script>
	<script type="text/javascript" src="Scripts/common.js"></script>
	<script type="text/javascript" src="Scripts/jquery-1.11.2.js"></script>
    <script type="text/javascript" src="Scripts/popupWindow.js"></script>
    <script type="text/javascript" src="Scripts/filter.js"></script>
    <script type="text/javascript" src="Scripts/jquery-ui.js"></script>
    <link rel="stylesheet" href="Styles/jquery-ui.css" />
    <script src="Scripts/multiselect/jquery.multiple.select.js" type="text/javascript"></script>
	<link rel="stylesheet" href="Styles/multiple-select.css" />
</head>
<body>
    <form id="form1" runat="server">
	<div id="divStep1" class="step" nextstep="divStep2" prevstep="divStep1" >
            <div class="pageContentHeader" style="padding: 5px;">
                Step 1: Select Entity to Update
			</div>
            <div style="padding: 10px;">
                <table style="border-collapse: collapse; width: 100%;">
                    <tr>
                        <td style="width: 70px; text-align:center;">
                            Entity:
                            <select id="ddlEntity" runat="server" >
                                <option value="0">-Select-</option>
                                <option value="AOR">AOR</option>
                                <option value="CR">CR</option>
                                <option value="Task">Task</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="divStep2" class="step" style="display: none;height: 345px; overflow-x: hidden; overflow-y: auto;" nextstep="divStep3" prevstep="divStep1" >
            <div class="pageContentHeader" style="padding: 5px;">
                Step 2: Select Field to Change
			</div>
            <div style="padding: 10px;">
                <table style="border-collapse: collapse; width: 100%;">
                    <tr>
                        <td style="width: 70px; text-align:center;">
                            Field to Change:
                            <select id="ddlFieldChange" runat="server" ></select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="divStep3" class="step" style="display: none;height: 345px; overflow-x: hidden; overflow-y: auto;" nextstep="divStep4" prevstep="divStep2" >
            <div class="pageContentHeader" style="padding: 5px;">
                Step 3: Select Existing Value to change
			</div>
            <div style="padding: 10px;">
                <table style="border-collapse: collapse; width: 100%;">
                    <tr>
                        <td style="width: 70px; text-align:center;">
                            Existing Value:
                            <select id="ddlExistingValue" runat="server" multiple="true" ></select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="divStep4" class="step" style="display: none;height: 345px; overflow-x: hidden; overflow-y: auto;" nextstep="divStep5" prevstep="divStep3" >
            <div class="pageContentHeader" style="padding: 5px;">
                Step 4: Select New Value:
			</div>
            <div style="padding: 10px;">
                <table style="border-collapse: collapse; width: 100%;">
                    <tr>
                        <td style="width: 70px;text-align:center;">
                            New Value:
                            <select id="ddlNewValue" runat="server"></select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div id="divStep5" class="step" style="display: none;height: 345px; overflow-x: hidden; overflow-y: auto;" nextstep="divStep1" prevstep="divStep4" >
            <div class="pageContentHeader" style="padding: 5px;">
                Step 5: Limit Entities to Update
			</div>
            <div style="padding: 10px;">
                <table style="border-collapse: collapse; width: 100%;">
                    <tr>
                        <td style="width: 70px;text-align:center;">
                            Entities:
                            <select id="ddlSelEntities" runat="server" multiple="true" ></select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>          
	<div id="divPageFooter" class="PopupFooter">
		<table cellpadding="0" cellspacing="0" style="width: 100%; text-align:right;">
			<tr>
				<td>&nbsp;</td>
                <td>
					<input type="button" id="btnBack" value="Back" />
				</td>
                <td>
					<input type="button" id="btnNext" value="Next" />
				</td>
                <td>
					<input type="button" id="btnFinish" value="Next" style="display:none;" />
				</td>
				<td>
					<input type="button" id="btnClose" value="Close" />
				</td>
			</tr>
		</table>
	</div>
	<div id="divPageDimmer" style="position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; background: grey; filter: alpha(opacity=60); opacity: .60; display: none;"></div>
	<div id="divSaving" style="position: absolute; left: 35%; top: 15%; padding: 10px; background: white; border: 1px solid grey; font-size: 18px; text-align: center; display: none;">
		<table>
			<tr>
				<td>WTS is Saving Data... Please wait...</td>
			</tr>
			<tr>
				<td>
					<img alt='' src="Images/loaders/progress_bar_blue.gif" /></td>
			</tr>
		</table>
	</div>
    <asp:ScriptManager ID="ScriptManager1" runat="server" EnablePageMethods="true"></asp:ScriptManager>
</form>
<script type="text/javascript">

     $(document).ready(function () {
         $("#btnBack").click(function () { btnBack_click(); return false; });
        $("#btnNext").click(function () { btnNext_onclick(); return false; });
        $("#btnSave").click(function () { btnSave_onclick(); return false; });
        $("#btnClose").click(function () { btnClose_click(); return false; });
    });

    function btnClose_click() {
        if ($('#btnNext').is(':enabled')) {
            QuestionBox('Confirm Close', 'Are you sure you would like to close?', 'Yes,No', 'confirmClose', 300, 300, this);
        }
        else {
            closeWindow();
        }
    }

    function confirmClose(answer) {
        if ($.trim(answer).toUpperCase() == 'YES') closeWindow();
    }

    function btnBack_click() {
                stepFinished($('.step:visible'), false);
    }

    function btnNext_onclick() {
        try {
            
            switch ($('.step:visible').attr('id')) {
                case 'divStep1':
                    if ($('#ddlEntity').val() == 0) {
                        MessageBox('Please select an Entity to continue.');
                    } else {

                        var opt = $('#ddlEntity option:selected');
                        var columnName = $(opt).val();
                        var textField = $(opt).text();

                        $('#<%=this.ddlFieldChange.ClientID %>').empty().append('<option value="0">-Select-</option>');

                        PageMethods.LoadEntityFields(columnName, LoadEntityFields_done, on_error);
                        //LoadValueOptions(idField, columnName, textField);
                        stepFinished($('.step:visible'), true);
                    }
                    break;
                case 'divStep2':
                    if ($('#ddlFieldChange').val() == 0) {
                        MessageBox('Please select a Field to continue.');
                    } else {
                        var opt = $('#ddlFieldChange option:selected');
			            var columnName = $(opt).val();
			            var textField = $(opt).text();
			            var idField = $(opt).attr('id_field');
                        
                        LoadExistingValues($('#ddlEntity').val(),idField, columnName, textField);
                        stepFinished($('.step:visible'), true);
                    }
                    break;
                case 'divStep3':
                    if ($('#ddlExistingValue').val() == 0) {
                        MessageBox('Please select an Existiing Value to continue.');
                    } else {
                        stepFinished($('.step:visible'), true);
                    }
                    break;
                case 'divStep4':
                        var opt = $('#ddlFieldChange option:selected');
                        var columnName = $(opt).val();
                        var textField = $(opt).text();
                        var idField = $(opt).attr('id_field');

                        var existingValueFilter = $('#<%=this.ddlExistingValue.ClientID %>').multipleSelect('getSelects');
			
                    LoadFilteredEntity($('#ddlEntity').val(), idField, columnName, textField, existingValueFilter.join(','));
                        stepFinished($('.step:visible'), true);
                    break;
                case 'divStep5':
                    var existingValue = $('#<%=this.ddlExistingValue.ClientID %>').multipleSelect('getSelects');
                    var entityFilter = $('#<%=this.ddlSelEntities.ClientID %>').multipleSelect('getSelects');
                    var newValue = $('#<%=this.ddlNewValue.ClientID %>').val();
                    var opt = $('#<%=this.ddlFieldChange.ClientID %> option:selected');
				    var columnName = $(opt).val();
				    var textField = $(opt).text();
				    var idField = $(opt).attr('id_field');

				    PageMethods.SaveChanges($('#ddlEntity').val(), columnName, existingValue.join(','), newValue, entityFilter.join(','), save_done, on_error);

                    stepFinished($('.step:visible'), true);
                    break;
            }
        }
        catch (e) { }
    }

    function stepFinished(objStep, blnNext) {
        var nextStep = $('#' + objStep.attr('nextstep'));
        var prevStep = $('#' + objStep.attr('prevstep'));
        if (blnNext) {
            objStep.hide("slide", { direction: "left" }, 500, function () {
                nextStep.show("slide", { direction: "right" }, 500);
            });
        }
        else {
            objStep.hide("slide", { direction: "right" }, 500, function () {
                prevStep.show("slide", { direction: "left" }, 500);
            });
        }
    }

    function save_done(result) {
        try {
            ShowDimmer(false);

            var obj = jQuery.parseJSON(result);

            var saved = false;
            var count = 0;
            var errorMsg = '';

            if (obj) {
                if (obj.saved) {
                    saved = (obj.saved.toUpperCase() == 'TRUE');
                }
                if (obj.Count) {
                    count = parseInt(obj.Count);
                }
                if (obj.error) {
                    errorMsg = obj.error;
                }
            }

            var msg = '';
            if (saved) {
                msg = 'Updated ' + count + ' Entity.';
            }
            else {
                msg = 'Failed to update Entity.';
            }

            if (errorMsg.length > 0) {
                if (msg.length > 0) {
                    msg += '\n';
                }
                msg += errorMsg;
            }

            MessageBox(msg);

            if (opener && opener.refreshPage) {
                opener.refreshPage(true);
            }
            refreshPage();
        } catch (e) {
            ShowDimmer(false);
        }
    }

    function LoadFilteredEntity(entityType, idField, columnName, textField, existingValueFilter) {
        try {
            $('#<%=this.ddlSelEntities.ClientID %>').empty();
            ShowDimmer(true, "Loading " + entityType + "...", 1);

            PageMethods.LoadFilteredEntity(entityType, idField, columnName, textField, existingValueFilter, LoadFilteredEntity_done, on_error);
        } catch (e) {
            ShowDimmer(false);
            MessageBox('There was an error gathering ' + entityType + ' list.\n' + e.message);
        }
    }

    function LoadFilteredEntity_done(result) {
        ShowDimmer(false);
            var dt = jQuery.parseJSON(result);

            if (dt != null && dt.length > 0) {
                
			    var value = '', text = '';
			    $.each(dt, function (index, val) {
				    value = '';
				    text = '';
				    id_field = '';

				    if (val.valueField) {
					    value = val.valueField;
				    }
				    if (val.textField) {
					    text = val.textField;
				    }
				    if (val.id_field) {
				        id_field = val.id_field;
				    }
				    $('#<%=this.ddlSelEntities.ClientID %>').append('<option value="' + value + '" id_field="' + id_field + '">' + text + '</option>');
			    });
            }


        $('#<%=ddlSelEntities.ClientID %>').multipleSelect({
            placeholder: 'Default'
				    , width: 'undefined'
					, onOpen: function () { }
					, onClose: function () { }
        }).change(function () { });
    }

    function LoadEntityFields_done(result) {
            var dt = jQuery.parseJSON(result);

            if (dt != null && dt.length > 0) {
                $('#<%=this.ddlFieldChange.ClientID %>').empty().append('<option value="0">-Select-</option>');

			    var value = '', text = '';
			    $.each(dt, function (index, val) {
				    value = '';
				    text = '';
				    id_field = '';

				    if (val.valueField) {
					    value = val.valueField;
				    }
				    if (val.textField) {
					    text = val.textField;
				    }
				    if (val.id_field) {
				        id_field = val.id_field;
				    }
				    $('#<%=this.ddlFieldChange.ClientID %>').append('<option value="' + value + '" id_field="' + id_field + '">' + text + '</option>');
			    });
            }
    }

    function on_error() {
        MessageBox('An error has occurred.');
    }

    function LoadExistingValues(entityType,idField, columnName, textField) {
        try {
            if (idField.length == 0 || textField.length == 0) {
                MessageBox('Unable to gather Exsisting Value list. Attribute selection is invalid.');
                return;
            }

            ShowDimmer(true, "Loading New Values for " + textField + "...", 1);

            PageMethods.LoadExistingValues(entityType,idField, columnName, textField, LoadExistingValues_done, on_error);
        } catch (e) {
            ShowDimmer(false);
            MessageBox('There was an error gathering Existing Value list.\n' + e.message);
        }
    }
    function LoadExistingValues_done(result) {
        try {
            ShowDimmer(false);

            var obj = jQuery.parseJSON(result);

            var loaded = false;
            var currentCount = 0, newCount = 0;
            var errorMsg = '';
            var dtCurrentOptions = {}, dtNewOptions = {};

            if (obj) {
                if (obj.loaded && obj.loaded.toUpperCase() == 'TRUE') {
                    loaded = true;
                }
                if (obj.CurrentCount) {
                    currentCount = parseInt(obj.CurrentCount);
                }
                if (obj.NewCount) {
                    newCount = parseInt(obj.NewCount);
                }
                if (obj.error) {
                    errorMsg = obj.error;
                }

                if (currentCount > 0 && obj.CurrentOptions) {
                    dtCurrentOptions = jQuery.parseJSON(obj.CurrentOptions);
                }
                if (newCount > 0 && obj.NewOptions) {
                    dtNewOptions = jQuery.parseJSON(obj.NewOptions);
                }

                populateOptions(dtCurrentOptions, dtNewOptions);
            }

        } catch (e) {
            ShowDimmer(false);
        }
    }

    function populateOptions(dtCurrentOptions, dtNewOptions) {
        $('#<%=this.ddlExistingValue.ClientID %>').empty();
        $('#<%=this.ddlNewValue.ClientID %>').empty();

        var value = '', text = '';
        $.each(dtCurrentOptions, function (index, val) {
            value = '';
            text = '';

            if (val.valueField) {
                value = val.valueField;
            }
            if (val.textField) {
                text = val.textField;
            }

            $('#<%=this.ddlExistingValue.ClientID %>').append('<option value="' + value + '">' + text + '</option>');
        });

        $('#<%=ddlExistingValue.ClientID %>').multipleSelect({
            placeholder: 'Default'
				    , width: 'undefined'
					, onOpen: function () { }
					, onClose: function () { }
        }).change(function () { });


        $.each(dtNewOptions, function (index, val) {
            value = '';
            text = '';

            if (val.valueField) {
                value = val.valueField;
            }
            if (val.textField) {
                text = val.textField;
            }

            $('#<%=this.ddlNewValue.ClientID %>').append('<option value="' + value + '">' + text + '</option>');
        });
    }
        

</script>
</body>
</html>