<%@ Page Language="C#" AutoEventWireup="true" CodeFile="FilterPage.aspx.cs" Inherits="FilterPage" theme="Default"%>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head id="Head1" runat="server">
    <title>Filter and Criteria</title>
    <script type="text/javascript" src="scripts/shell.js"></script>
    <script type="text/javascript" src="scripts/filter.js"></script>
    <script type="text/javascript" src="scripts/PopupWindow.js"></script>
    <script type="text/javascript" src="Scripts/jquery-1.11.2.js"></script>
	<script type="text/javascript" src="Scripts/jquery.json-2.4.min.js"></script>

    <link rel="stylesheet" type="text/css" href="Styles/Default.css" /> 

   
    
    
    
    
    
    
    
    
    <style type="text/css"> 
       .LockOff { 
          display: none; 
          visibility: hidden; 
       } 

       .LockOn { 
          display: block; 
          visibility: visible; 
          position: absolute; 
          z-index: 999; 
          top: 0px; 
          left: 0px; 
          width: 105%; 
          height: 105%; 
          background-color: #ccc; 
          text-align: center; 
          padding-top: 20%; 
          filter: alpha(opacity=75); 
          opacity: 0.75; 
       } 
    </style> 

    <script type="text/javascript"> 
       function skm_LockScreen(str) 
       { 
          var lock = document.getElementById('skm_LockPane'); 
          if (lock) 
             lock.className = 'LockOn'; 

          lock.innerHTML = str; 
       } 

       function skm_UnLockScreen() {
           var lock = document.getElementById('skm_LockPane');
           lock.className = 'LockOff';

           lock.innerHTML = '';
       }
    </script>
    
    




    
        
    <style type="text/css">
        .filterFields {
            cursor:default;
            font-size:12px;
            border:solid 1px grey;

            overflow-x:hidden;
            overflow-y:auto;
        }
            .filterFields li {
                padding:3px;
                border-bottom:solid 1px gainsboro;
            }
            .filterFields li:not(.filterFieldsHeader):hover {
                background:#d7e8fc;
            }
        .filterFieldsItem {
            background:url(images/header/page_header_back.gif);
        } 
        .filterFieldsHeader {
            background:url(images/headers/gridheaderblue.png);
            font-weight:bold;
            text-align:center;
        }
        .filterFieldsSelected {
            background:#d7e8fc;
        }

        select {
            font-size:12px;
        }
    </style>
</head>
<body>
    <form id="form1" method ="post" runat="server">
		<div style="text-align: center; padding-top: 10px; padding-left:10px;">
			<table style="width: 100%;">
				<tr style="vertical-align: top;">
					<td>Field
					</td>
					<td>Available Filters
					</td>
					<td>&nbsp;
					</td>
					<td>Selected Filters
					</td>
					<td>Applied Filters
					</td>
				</tr>
				<tr style="vertical-align: top;">
					<td>
<%--   						<ul id="lstFilterFields" class="filterFields" runat="server" style="width: 180px;">
						</ul>--%>

						<ul id="lstFilterFields" class="filterFields" runat="server" onclick="skm_LockScreen('Gathering filters...');" style="width: 180px;">
						</ul>
                        <div id="skm_LockPane" class="LockOff"></div>
					</td>
					<td>
						<asp:ListBox ID="lstAvailableFilters" runat="server" Style="width: 180px;" SelectionMode="Multiple"></asp:ListBox>
					</td>
					<td style="vertical-align: middle;">
						<table>
							<tr>
								<td>
									<button id="btnAdd" style="width: 100px" onclick="btnAdd_Click(); return false;">>></button>
								</td>
							</tr>
							<tr>
								<td>
									<button id="btnRemove" style="width: 100px" onclick="btnRemove_Click(); return false;"><<</button>
								</td>
							</tr>
							<tr>
								<td>
									<button id="btnClearAll" style="width: 100px" onclick="btnClearAll_Click(); return false;">Clear All</button>
								</td>
							</tr>
						</table>
					</td>
					<td>
						<asp:ListBox ID="lstSelectedFilters" runat="server" Style="width: 180px;" SelectionMode="Multiple"></asp:ListBox>
					</td>
					<td>
						<div id="lstAppliedFilters" class="filterContainer" style="width: 180px; text-align: left;"></div>
					</td>
				</tr>
			</table>
		</div>
		<div id="filterFooter" class="PopupFooter">
			<table>
				<tr>
					<td>
						<button id="btnSave" onclick="btnSave_Click(); return false;">Finish</button>
					</td>
					<td>
						<button id="btnCancel" onclick="closeWindow(); return false;">Cancel</button>
					</td>
				</tr>
			</table>
		</div>
		<asp:ScriptManager ID="PageMethods" runat="server" EnablePageMethods="true"></asp:ScriptManager>
		<script type="text/javascript">
			var lstFilterFields = document.getElementById('lstFilterFields');
			var lstAvailableFilters = document.getElementById('lstAvailableFilters');
			var btnAdd = document.getElementById('btnAdd');
			var btnRemove = document.getElementById('btnRemove');
			var btnClearAll = document.getElementById('btnClearAll');
			var lstSelectedFilters = document.getElementById('lstSelectedFilters');
			var lstAppliedFilters = document.getElementById('lstAppliedFilters');
			var filterFooter = document.getElementById('filterFooter');
			var parentModule = '<%=HttpContext.Current.Request.QueryString["parentModule"]%>';
			var filterBox;

			if ('<%=this.Source %>' == 'AOR' && opener && opener.filterBox != undefined) {
				filterBox = opener.filterBox.clone(lstAppliedFilters);
			}
			else {
				 filterBox = top.filterBox.clone(lstAppliedFilters);
			}

			filterBox.editableDisplay = true;
			filterBox.toTable({ groups: { ParentModule: parentModule } }, 'Module');

			var strSelectedFilterField = '';
			var selectedFilterItem = '';

			function filterField_Click(el) {
				if (selectedFilterItem != el) {
					if (selectedFilterItem) {
						selectedFilterItem.className = 'filterFieldsItem';
					}
					selectedFilterItem = el;

					selectedFilterItem.className = 'filterFieldsSelected';
					strSelectedFilterField = ($(selectedFilterItem).attr('field')) ? $(selectedFilterItem).attr('field') : selectedFilterItem.innerText;
				}

				loadSelectedFilter(el.getAttribute('FIELD'));
			}

			function loadSelectedFilter(filterName) {
				lstSelectedFilters.options.length = 0;
				lstAvailableFilters.options.length = 0;
				var filters = filterBox.toJSON({ groups: { ParentModule: parentModule } });

				var myData = ('<%=this._myData.ToString().ToUpper() %>' == 'TRUE');

			    PageMethods.LoadFilters(parentModule, filterName, filters, myData, loadSelectedFilter_Done, OnError);
			}

			function loadSelectedFilter_Done(results) {
				if (results && results != "null") {
					results = jQuery.parseJSON(results);

					var filter = filterBox.filters.find({ name: strSelectedFilterField, groups: { ParentModule: parentModule, Module: "Custom" } })[0];

					for (var i = 0; i <= results.length - 1; i++) {
						var nOpt = document.createElement('option');
						nOpt.value = results[i].FilterID;
						nOpt.text = results[i].FilterValue;

						var selectedParameter = '';
						if (filter) {
							selectedParameter = filter.parameters.findByValue(nOpt.value);
						}
						if (!selectedParameter) {
							lstAvailableFilters.options.add(nOpt);
						}
					}
					if (filter) {
						for (var i = 0; i <= filter.parameters.length - 1; i++) {
							var nOpt = document.createElement('option');
							nOpt.value = filter.parameters[i].value;
							nOpt.text = filter.parameters[i].text;

							lstSelectedFilters.options.add(nOpt);
						}
					}
				}
				skm_UnLockScreen();
			}

			function OnError(e) {
			    skm_UnLockScreen();
			    MessageBox(e._message);
			};

			function btnAdd_Click() {
				for (var i = 0; i <= lstAvailableFilters.options.length - 1; i++) {
					if (lstAvailableFilters.options[i].selected) {
						var nOpt = document.createElement('option');
						nOpt.value = lstAvailableFilters.options[i].value;
						nOpt.text = lstAvailableFilters.options[i].text;

						lstSelectedFilters.options.add(nOpt);
						filterBox.filters.add({ name: strSelectedFilterField, groups: { ParentModule: parentModule, Module: "Custom" } }).parameters.add(nOpt.value, nOpt.text);

						lstAvailableFilters.options.remove(i);
						i--;
					}
				}

				filterBox.toTable({ groups: { ParentModule: parentModule } }, 'Module');
			}

			function btnRemove_Click() {
				for (var i = 0; i <= lstSelectedFilters.options.length - 1; i++) {
					if (lstSelectedFilters.options[i].selected) {
						var nOpt = document.createElement('option');
						nOpt.value = lstSelectedFilters.options[i].value;
						nOpt.text = lstSelectedFilters.options[i].text;

						lstAvailableFilters.options.add(nOpt);
						filterBox.filters.find({ name: strSelectedFilterField, groups: { ParentModule: parentModule, Module: "Custom" } })[0].parameters.findByValue(nOpt.value).remove();

						lstSelectedFilters.options.remove(i);
						i--;
					}
				}

				filterBox.toTable({ groups: { ParentModule: parentModule } }, 'Module');
			}

			function btnClearAll_Click() {
				var filters = filterBox.filters.find({ groups: { ParentModule: parentModule, Module: "Custom" } });
				if (filters) {
					filters.clear();
					filterBox.toTable({ groups: { ParentModule: parentModule } }, 'Module');
				}

				if (strSelectedFilterField != '') loadSelectedFilter(strSelectedFilterField);
			}

			function btnSave_Click() {
				if ('<%=this.Source %>' == 'AOR' && opener && opener.filterBox != undefined) {
					opener.filterBox = filterBox.clone(opener.filterBox.containerElement);
					opener.filterBox.toTable({ groups: { ParentModule: parentModule } }, 'Module');
					$('#txtTaskSearch', opener.document).val('');

					if (opener.loadGrid) opener.loadGrid();
				}
				else {
					top.filterBox = filterBox.clone(top.filterBox.containerElement);
					top.filterBox.toTable({ groups: { ParentModule: parentModule } }, 'Module');
					try { opener.saveFilters(false, "Load_HomePage"); } catch (e) { }
				}
				
				closeWindow();
			}

			function resizePage() {
				resizePageElement('lstFilterFields', filterFooter.offsetHeight + 10);
				resizePageElement('lstAvailableFilters', filterFooter.offsetHeight + 8);
				resizePageElement('lstSelectedFilters', filterFooter.offsetHeight + 8);
				resizePageElement('lstAppliedFilters', filterFooter.offsetHeight + 10);
			}

		</script>
    </form>

	<script id="jsInit" type="text/javascript">
		
		$(document).ready(function () {
			$(window).resize(resizePage);

			resizePage();
		});
	</script>
</body>
</html>
