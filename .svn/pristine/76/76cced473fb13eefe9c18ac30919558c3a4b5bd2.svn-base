<%@ Page Title="" Language="C#" MasterPageFile="~/EditTabs.master" EnableViewState="false" AutoEventWireup="true" CodeFile="Task_Edit.aspx.cs" Inherits="Task_Edit" Theme="Default" %>

<asp:Content ID="cpHeadTitle" ContentPlaceHolderID="headTitle" runat="Server">Workload Sub-Task</asp:Content>
<asp:Content ID="cpHead" ContentPlaceHolderID="head" runat="Server">
	<link rel="stylesheet" href="Scripts/cleditor/jquery.cleditor.css" />
	<link rel="stylesheet" href="Styles/jquery-ui.css" />
	<script type="text/javascript" src="Scripts/jquery-1.11.2.js" ></script>
	<script type="text/javascript" src="Scripts/common.js"></script>
	<script type="text/javascript" src="Scripts/shell.js"></script>
	<script type="text/javascript" src="Scripts/popupWindow.js"></script>
    <style type="text/css">
        .auto-style1 {
            width: 93px;
        }
        .auto-style2 {
            width: 130px;
        }
        .auto-style3 {
            width: 42px;
        }
    </style>
</asp:Content>
<asp:Content ID="cpHeaderImage" ContentPlaceHolderID="ContentPlaceHolderHeaderImage" runat="Server">
	<img src="images/icons/pencil.png" alt="Review/Edit Task" width="15" height="15" style="cursor: default;" />
</asp:Content>
<asp:Content ID="cpHeaderText" ContentPlaceHolderID="ContentPlaceHolderHeaderText" runat="Server">Workload Sub-Task</asp:Content>
<asp:Content ID="cpHeaderMisc" ContentPlaceHolderID="ContentPlaceHolderHeaderMisc" runat="Server">
	<span id="labelMessage" style="color: red; padding-left: 15px;"></span>
</asp:Content>
<asp:Content ID="cpHeaderButtons" ContentPlaceHolderID="ContentPlaceHolderHeaderButtons" runat="Server">
	<img src="Images/Icons/help.png" id="helpButton" style="cursor: pointer"/>
    <input type="button" id="buttonHistory" value="History" />
	<input type="button" id="buttonClose" value="Close" />
	<input type="button" id="buttonSave" runat="server" value="Save" />
	<input type="button" id="buttonSaveAndClose" value="Save and Close" style="display: none;" />
	<input type="button" id="buttonSaveAndClear" value="Save and Add Another" style="display: none;" />
</asp:Content>
<asp:Content ID="cpBody" ContentPlaceHolderID="ContentPlaceHolderBody" runat="Server">
	<asp:ScriptManager ID="scriptManager1" runat="server" EnablePageMethods="true"></asp:ScriptManager>

	<div id="divPageContainer" class="pageContainer">
		<div id="divTabsContainer" class="mainPageContainer">
			<ul id="Tabs">
				<li><a id="tabDetails" href="#divDetailsTab" onclick="Tab_click('details');">Details</a></li>
				<li><a id="tabNotes" href="#divNotes" onclick="Tab_click('notes');">Notes</a></li>
                <li><a id="tabAttachments" href="#divAttachments" onclick="Tab_click('attachments');">Attachments</a></li>
			</ul>
			<div id="divDetailsTab">
				<div id="divDetailsContainer" class="attributesRow" style="vertical-align: top; overflow-x: hidden;">
					<div id="divDetailsHeader" class="pageContentHeader" style="padding: 5px;">
						<div class="attributesRequired" style="width: 10px; display: inline;">
							<img id="imgHideDetails" class="hideSection" sectionname="Details" alt="Hide Task Details" title="Hide Task Details" src="images/icons/minus_blue.png" height="10" width="10" style="cursor: pointer;" />
							<img id="imgShowDetails" class="showSection" sectionname="Details" alt="Show Task Details" title="Show Task Details" src="images/icons/add_blue.png" height="10" width="10" style="cursor: pointer; display: none;" />
						</div>
						<div class="attributesLabel" style="padding-left: 5px; display: inline;">Details:</div>
					</div>
					<table id="tableDetails" cellpadding="0" cellspacing="0" style="width: 100%; vertical-align: top; text-align: left; padding-top: 5px; padding-bottom:10px;">
						<tr>
							<td colspan="2" style="text-align: left; vertical-align: top;">
								<table cellpadding="0" cellspacing="0" style="width: 100%; vertical-align: top;">
									<tr id="trWorkItem" class="attributesRow">
										<td class="attributesRequired">&nbsp;</td>
										<td name="FirstLabel" class="attributesLabel">Workload Sub-Task:</td>
										<td class="attributesValue">
											<asp:TextBox ID="txtWorkloadNumber" runat="server" Width="75" BackColor="#cccccc" ReadOnly="true" Style="text-align: right;" onkeydown="return false;" />
										</td>
									</tr>
									<tr id="trTitle" class="attributesRow">
										<td class="attributesRequired">*</td>
										<td name="FirstLabel" class="attributesLabel">Title:</td>
										<td class="attributesValue">
											<asp:TextBox ID="txtTitle" runat="server" Width="98%" />
										</td>
									</tr>
								</table>
							</td>
						</tr>
						<tr id="trAuditing">
                            <td colspan="2" style="text-align: left; vertical-align: top;">
                                <table cellpadding="0" cellspacing="0" style="width: 100%; vertical-align: top; text-align: left;">
								    <tr>
									    <td class="attributesValue" style="padding-left: 160px;">Created:&nbsp;
										    <asp:Label ID="labelCreated" runat="server" />
									    </td>
                                        <td class="attributesValue" style="text-align: right; padding-right: 13px;">
										    Updated:&nbsp;
										    <asp:Label ID="labelUpdated" runat="server" />
									    </td>
								    </tr>
							    </table>
                            </td>
					    </tr>
						<tr>
							<td id="tdLeftCol2" style="vertical-align: top; width: 350px;">
								<table cellpadding="0" cellspacing="0" style="width: 100%; vertical-align: top; text-align: left;">
									<tr id="trSecondaryResource" class="attributesRow" style="display:none;">
										<td class="attributesRequired"></td>
										<td name="FirstLabel" class="attributesLabel">
                                            Secondary Tech Resource:
										</td>
										<td class="attributesValue">
											<asp:DropDownList ID="ddlSecondaryResource" runat="server" Style="font-size: 12px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
									</tr>
									<tr id="trPrimaryBusResource" class="attributesRow" style="display:none;">
										<td class="attributesRequired"></td>
										<td name="FirstLabel" class="attributesLabel">
                                            Primary Bus Resource:
										</td>
										<td class="attributesValue">
											<asp:DropDownList ID="ddlPrimaryBusResource" runat="server" Style="font-size: 12px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
									</tr>
									<tr id="trSecondaryBusResource" class="attributesRow" style="display:none;">
										<td class="attributesRequired"></td>
										<td name="FirstLabel" class="attributesLabel">
                                            Secondary Bus Resource:
										</td>
										<td class="attributesValue">
											<asp:DropDownList ID="ddlSecondaryBusResource" runat="server" Style="font-size: 12px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
									</tr>
									<tr id="trPriority" class="attributesRow">
										<td class="attributesRequired">*</td>
										<td name="FirstLabel" class="attributesLabel">
                                            Priority:
										</td>
										<td class="attributesValue">
											<asp:DropDownList ID="ddlPriority" runat="server" Style="font-size: 12px; width: 160px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
									</tr>
									<tr id="trStatus" class="attributesRow">
										<td class="attributesRequired">*</td>
										<td name="LeftColumn" class="attributesLabel">
                                            Status:
										</td>
										<td class="attributesValue">
											<asp:DropDownList ID="ddlStatus" runat="server" Style="font-size: 12px; width: 160px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
									</tr>
                                    <tr>
										<td id="tdProductVersionRequired" class="attributesRequired">&nbsp;</td>
										<td class="attributesLabel">
                                            Product Version:
										</td>
										<td class="attributesValue">
											<asp:Label ID="lblProductVersion" runat="server" />
                                            <asp:DropDownList ID="ddlProductVersion" runat="server" Style="font-size: 12px; width: 160px; display: none;" AppendDataBoundItems="true">
											    <asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
										    </asp:DropDownList>
                                            <a id="aEdit" href="" style="color: blue; padding-left: 5px; display: none;">Edit</a>
										</td>
									</tr>
									<tr id="trPercentComplete" class="attributesRow">
										<td class="attributesRequired">&nbsp;</td>
										<td name="FirstLabel" class="attributesLabel">
                                            Percent Complete:
										</td>
										<td class="attributesValue">
											<asp:DropDownList ID="ddlPercentComplete" runat="server" Style="font-size: 12px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true"></asp:DropDownList>
										</td>
									</tr>
   									<tr id="trSRNumber" class="attributesRow">
										<td class="attributesRequired">&nbsp;</td>
										<td class="attributesLabel">
                                            SR Number:
										</td>
										<td class="attributesValue">
											<asp:TextBox ID="txtSRNumber" runat="server" TextMode="Number" Style="width: 75px;" ></asp:TextBox>
										</td>
									</tr>
								</table>
							</td>
							<td id="tdRightCol2" style="vertical-align: top;">
								<table cellpadding="0" cellspacing="0" style="vertical-align: top; text-align: left;">
									<tr id="trPlannedStart" class="attributesRow" style="display:none;"> 
										<td class="auto-style3">&nbsp;</td>
										<td name="FirstLabel" class="auto-style2">
                                            Planned Start Date:
										</td>
										<td class="auto-style1">
											<asp:TextBox ID="txtStartDate_Planned" runat="server" Style="width: 75px;" />
										</td>
									</tr>
									<tr id="trActualStart" class="attributesRow" style="display:none;">
										<td class="auto-style3">&nbsp;</td>
										<td name="FirstLabel" class="auto-style2">
                                            Actual Start Date:
										</td>
										<td class="auto-style1">
											<asp:TextBox ID="txtStartDate_Actual" runat="server" Style="width: 75px;" />
										</td>
									</tr>
									<tr id="trPlannedHours" class="attributesRow" style="display:none;">
										<td class="auto-style3">&nbsp;</td>
										<td name="FirstLabel" class="auto-style2">
                                            Estimated Effort:
										</td>
										<td class="auto-style1">
											<asp:DropDownList ID="ddlHours_Planned" runat="server" Style="font-size: 12px; width: 80px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
       	    							<td class="auto-style6" style="text-align: left;">
    	    							    <img id="imgEffortHelp" runat="server" src="Images/Icons/help.png" alt="Help" title="Help" width="15" height="15" style="cursor: pointer; display: block;" />
    								    </td>
									</tr>
									<tr id="trActualHours" class="attributesRow" style="display:none;">
										<td class="auto-style3">&nbsp;</td>
										<td name="FirstLabel" class="auto-style2">
                                            Actual Effort:
										</td>
										<td class="auto-style1">
											<asp:DropDownList ID="ddlHours_Actual" runat="server" Style="font-size: 12px; width: 80px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
	                                </tr>
									<tr id="trActualEnd" class="attributesRow" style="display:none;">
										<td class="auto-style3">&nbsp;</td>
										<td name="FirstLabel" class="auto-style2">
                                            Actual End Date:
										</td>
										<td class="auto-style1">
											<asp:TextBox ID="txtEndDate_Actual" runat="server" Style="width: 75px;" />
										</td>
									</tr>



   									<tr id="trBusinessRank" class="attributesRow" style="display:none;">
										<td class="auto-style3">&nbsp;</td>
										<td name="LeftColumn" class="auto-style2">
                                            Bus. Rank:
										</td>
										
									</tr>
									<tr id="trSort" class="attributesRow" style="display:none;">
										<td class="auto-style3">&nbsp;</td>
										<td name="LeftColumn" class="auto-style2">
                                            Tech. Rank:
										</td>
										<td class="auto-style1">
											<asp:TextBox ID="txtSortOrder" runat="server" TextMode="Number" Style="width: 75px;" />
										</td>
									</tr>
                                    <tr id="trAssignedTo" class="attributesRow">
										<td class="attributesRequired">*</td>
										<td name="FirstLabel" class="attributesLabel">
                                            Assigned To:
										</td>
										<td class="attributesValue">
											<asp:DropDownList ID="ddlAssignedTo" runat="server" Style="font-size: 12px; width: 160px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
									</tr>
									<tr id="trPrimaryResource" class="attributesRow">
										<td class="attributesRequired">*</td>
										<td name="FirstLabel" class="attributesLabel">
                                            Primary Resource:
										</td>
										<td class="attributesValue">
											<asp:DropDownList ID="ddlPrimaryResource" runat="server" Style="font-size: 12px; width: 160px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
												<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
											</asp:DropDownList>
										</td>
									</tr>
                                    <tr id="trAssignedToRank" class="attributesRow">
										<td class="attributesRequired">*</td>
										<td name="LeftColumn" class="auto-style2">
                                            Assigned To Rank:
										</td>
										<td class="auto-style1">
											<asp:DropDownList ID="ddlAssignedToRank" runat="server" Style="font-size: 12px; width: 160px; padding-left: 0px;" Enabled="true" AppendDataBoundItems="true">
											<asp:ListItem Text="-Select-" Value="0"></asp:ListItem>
										    </asp:DropDownList>
										</td>
									</tr>
									<tr id="trCustomerRank" class="attributesRow">
										<td class="attributesRequired">&nbsp;</td>
										<td name="LeftColumn" class="auto-style2">
                                            Customer Rank:
										</td>
										<td class="auto-style1">
											<asp:TextBox ID="txtBusinessRank" runat="server" TextMode="Number" Style="width: 75px;" />
										</td>
									</tr>

								</table>
							</td>
						</tr>
					</table>
				</div>
				<div id="divDescriptionContainer" class="attributesRow" style="vertical-align: top; width: 99%;">
					<div id="divDescriptionHeader" class="pageContentHeader" style="padding: 5px;">
						<div class="attributesRequired" style="width: 10px; display: inline;">
						</div>
						<div class="attributesLabel" style="padding-left: 5px; display: inline;">Description:</div>
					</div>
					<div id="divDescription" class="attributesValue" style="padding: 10px 0px 10px 20px;">
						<textarea id="textAreaDescription" runat="server" rows="20" style="width: 98%;"></textarea>
					</div>
				</div>
			</div>
			<div id="divNotes">
				<iframe id="frameComments" src="javascript:'';" frameborder="0" scrolling="no" style="display: block; width: 100%;"></iframe>
			</div>
            <div id="divAttachments">
				<iframe id="frameAttachments" name="frameAttachments" class="contentFrame" runat="server" src="javascript:'';" scrolling="no" frameborder="0" style="width: 100%; height: 100%; margin: 0px; padding: 0px;" title="">Work Item Attachments</iframe>
			</div>
		</div>
	</div>

	<script type="text/javascript" src="Scripts/jquery-ui.js"></script>
	<script src="Scripts/cleditor/jquery.cleditor.js"></script>

	<script id="jsVariables" type="text/javascript">
		var _pageUrls;
		var _canEdit = false;
		var _taskID = 0, _workItemID = 0, _commentQty = 0;
	</script>

	<script id="jsEvents" type="text/javascript">

		function SetCommentQty(qty) {
			if (!qty) {
				qty = 0;
			}

			$('#tabNotes').text('Notes (' + qty + ')');
		}

		function SetAttachmentQty(qty) {
		    if (!qty) {
		        qty = 0;
		    }

		    $('#tabAttachments').text('Attachments (' + qty + ')');
		}

		function refreshPage(newID, saved) {
			var url = window.location.href;
			if (newID > 0) {
				url = editQueryStringValue(url, 'taskID', newID);
			}
			else {
				url = editQueryStringValue(url, 'taskID', 0);				
			}

			if (!saved) {
				url = editQueryStringValue(url, 'Saved', '0');
			}
			else {
				url = editQueryStringValue(url, 'Saved', '1');
			}

			window.location.href = 'Loading.aspx?Page=' + url;
		}

		function clearMessage() {
			$('#labelMessage').text('');
			$('#labelMessage').hide();
		}

		function buttonHistory_click() {
			var title = '', url = '';
			var h = 600, w = 1000;

			title = 'Work Item Task History';
			url = _pageUrls.Maintenance.WorkItemHistory
				+ '?type=WorkItemTask'
				+ '&workItemTaskID=' + _taskID
			;

			//open in a popup
			var openPopup = popupManager.AddPopupWindow('WorkItemTaskHistory', title, 'Loading.aspx?Page=' + url, h, w, 'PopupWindow', this);
			if (openPopup) {
				openPopup.Open();
			}
		}

		function closePage() {
			if (closeWindow) {
				closeWindow();
			}
			else {
				window.close();
			}
		} //end closePage()

		function buttonClose_click() {
			clearMessage();
			//TODO: check for changes

			closePage();
		}

		function buttonSave_click(pageOption) {
			clearMessage();
			var msg = validateFields();

			if (msg.length > 0) {
				MessageBox('Please update the following fields:\n' + msg);
				return;
			}
			if (document.getElementById("frameComments").contentWindow.SaveComments) {
		        document.getElementById("frameComments").contentWindow.SaveComments();
		    }
			save(pageOption);
		}

		function validateFields() {
			var invalidFields = [];
			var msg = '';

			if ($('#<%=this.txtTitle.ClientID %>').val() == '') {
				invalidFields.push('Title is required');
			}
			if ($('#<%=this.ddlAssignedTo.ClientID %>').val() == 0) {
				invalidFields.push('Assigned To is required');
			}
			//todo: add date validation

            if ($('#<%=this.ddlPriority.ClientID %>').val() == 0) {
				invalidFields.push('Priority is required');
			}

			if ($('#<%=this.ddlStatus.ClientID %>').val() == 0) {
				invalidFields.push('Status is required');
			}

            if ($('#<%=this.ddlPrimaryResource.ClientID %>').val() == 0) {
				emptyFields.push('Primary Resource');
			}

            if ($('#<%=this.ddlProductVersion.ClientID %>').val() == 0) {
				emptyFields.push('Product Version');
			}

            if ($('#<%=this.ddlAssignedToRank.ClientID %>').val() == 0) {
                invalidFields.push('Assigned To Rank is required');
            }

			if (invalidFields.length > 0) {
				msg = invalidFields.join('\n');
			}

			return msg;
		}

		function resizePage() {
			var heightModifier = 0;

			resizePageElement('divPageContainer', heightModifier + 2);
			resizePageElement('divTabsContainer', heightModifier + 3);
			resizePageElement('frameComments', heightModifier + 12);

			resizePageElement('divDetailsTab', heightModifier + 11);
			resizePageElement('divNotes', heightModifier + 11);

			resizeFrames();
		}

		function resizeFrames() {
			var frame;
			var fPageHeight = 0;

			frame = $('#frameComments')[0];
			if (frame.contentWindow
					&& frame.contentWindow.document
					&& frame.contentWindow.document.body
					&& frame.contentWindow.document.body.offsetHeight) {
				fPageHeight = frame.contentWindow.document.body.offsetHeight;
			}
			frame.style.height = fPageHeight + 'px';
		}

		function showHideSection_click(imgId, show, sectionName) {
			clearMessage();

			if (show) {
				$('#div' + sectionName).show();
				$('#table' + sectionName).show();
				$('#' + imgId).hide();
				$('#' + imgId.replace('Show', 'Hide')).show();
				$('tr[section="' + sectionName + '"]').show();

				switch (sectionName) {
					case "Comments":
						if ($('#frameComments').attr('src') == "javascript:'';") {
							loadComments();
						}
						break;
				}
			}
			else {
				$('#div' + sectionName).hide();
				$('#table' + sectionName).hide();
				$('#' + imgId).hide();
				$('#' + imgId.replace('Hide', 'Show')).show();
				$('tr[section="' + sectionName + '"]').hide();
			}

			resizeFrames();
		}

		function txt_change(sender) {
			clearMessage();

			var original_value = '', new_value = '';
			if ($(sender).attr('original_value')) {
				original_value = $(sender).attr('original_value');
			}

			new_value = $(sender).val();

			if (new_value != original_value) {
				activateSaveButton();
			}
		}

		function activateSaveButton() {
			clearMessage();

			if (_canEdit) {
				$('#buttonSave').removeAttr('disabled');
			}
		}

		function loadComments() {
			var url = window.location.search;
			url = editQueryStringValue(url, 'Saved', '0');
			url = 'Loading.aspx?Page=Task_Comments.aspx' + url;

			$('#frameComments').attr('src', url);
		}

		function loadAttachments() {
		    var url = window.location.search;
		    url = editQueryStringValue(url, 'Saved', '0');
		    url = 'Loading.aspx?Page=Task_Attachments.aspx' + url;

		    $('#<%=this.frameAttachments.ClientID%>').attr('src', url);

		}
		


		function Tab_click(tabName) {
			$('#divTabsContainer').children('div').hide();

			switch (tabName.toUpperCase()) {
				case 'DETAILS':
					$('#divDetailsTab').show();

					break;
				case 'NOTES':
					if ($('#frameComments') && $('#frameComments').attr('src') == "javascript:'';") {
						loadComments();
					}
					$('#divNotes').show();

					break;
                case 'ATTACHMENTS':
                    if ($('#<%=this.frameAttachments.ClientID%>') && $('#<%=this.frameAttachments.ClientID%>').attr('src') == "javascript:'';") {
                        loadComments();
                    }
					$('#divAttachments').show();

					break;
			}

			resizePage();
		}

	    function aEdit_click() {
	        $('#aEdit').hide();
	        $('#tdProductVersionRequired').text('*');
	        $('#<%=this.lblProductVersion.ClientID %>').hide();
	        $('#<%=this.ddlProductVersion.ClientID %>').show();
	        
	        MessageBox('Warning - Manually changing the Product Version should be done carefully as this will affect the tracking from AOR.');
	    }
	</script>

	<script id="jsAJAX" type="text/javascript">

		function save(pageOption) {
			var title = '', description = '', plannedStart = '', actualStart = '', actualEnd = '';
			var estimatedEffortID = 0, actualEffortID = 0, percentComplete = 0, assignedToID = 0, primaryResourceID = 0, secondaryResourceID = 0
				, primaryBusResourceID, secondaryBusResourceID, priorityID = 0, statusID = 0, busRank = 0, sortOrder = 0, srNumber = 0, assignedToRankID = 0, productVersionID = 0;

			if (!pageOption || pageOption == undefined || pageOption == null) {
				pageOption = '';
			}

			priorityID = parseInt($('#<%=this.ddlPriority.ClientID %> option:selected').val());
			title = $('#<%=this.txtTitle.ClientID %>').val();
			description = encodeURIComponent($('#<%=this.textAreaDescription.ClientID %>').val());
			plannedStart = $('#<%=this.txtStartDate_Planned.ClientID %>').val();
			actualStart = $('#<%=this.txtStartDate_Actual.ClientID %>').val();
			actualEnd = $('#<%=this.txtEndDate_Actual.ClientID %>').val();
			estimatedEffortID = parseInt($('#<%=this.ddlHours_Planned.ClientID %> option:selected').val());
			actualEffortID = parseInt($('#<%=this.ddlHours_Actual.ClientID %> option:selected').val());
			percentComplete = parseInt($('#<%=this.ddlPercentComplete.ClientID %> option:selected').val());
			assignedToID = parseInt($('#<%=this.ddlAssignedTo.ClientID %> option:selected').val());
			primaryResourceID = parseInt($('#<%=this.ddlPrimaryResource.ClientID %> option:selected').val());
		    secondaryResourceID = parseInt($('#<%=this.ddlSecondaryResource.ClientID %> option:selected').val());
			primaryBusResourceID = parseInt($('#<%=this.ddlPrimaryBusResource.ClientID %> option:selected').val());
		    secondaryBusResourceID = parseInt($('#<%=this.ddlSecondaryBusResource.ClientID %> option:selected').val());
			statusID = parseInt($('#<%=this.ddlStatus.ClientID %> option:selected').val());
			busRank = $('#<%=this.txtBusinessRank.ClientID %>').val() == '' ? 0 : parseInt($('#<%=this.txtBusinessRank.ClientID %>').val());
		    sortOrder = $('#<%=this.txtSortOrder.ClientID %>').val() == '' ? 0 : parseInt($('#<%=this.txtSortOrder.ClientID %>').val());
		    srNumber = $('#<%=this.txtSRNumber.ClientID %>').val();
		    assignedToRankID = parseInt($('#<%=this.ddlAssignedToRank.ClientID %> option:selected').val());
            productVersionID = parseInt($('#<%=this.ddlProductVersion.ClientID %> option:selected').val());
		    

			PageMethods.SaveTask(_taskID, _workItemID, priorityID
				, title, description, assignedToID, primaryResourceID, secondaryResourceID, primaryBusResourceID, secondaryBusResourceID
				, plannedStart, actualStart, estimatedEffortID, actualEffortID, actualEnd
				, percentComplete, statusID, busRank, sortOrder, pageOption, srNumber, assignedToRankID, productVersionID
				, save_done, on_error);
		}

		function save_done(result) {
			var saved = false;
			var id = 0;
			var errorMsg = '', pageOption = '';

			try {
				var obj = jQuery.parseJSON(result);

				if (obj) {
					if (obj.saved && obj.saved.toUpperCase() == 'TRUE') {
						saved = true;
					}
					if (obj.id) {
						id = obj.id;
					}
					if (obj.error) {
						errorMsg = obj.error;
					}
					if (obj.pageOption) {
						pageOption = obj.pageOption;
					}
				}

				if (saved) {
				    if (window && window.refreshPage) {
				        if (window.location.href.indexOf('WorkItemGrid.aspx') != -1) {
				            window.refreshPage(true);
				        }
				        else {
				            opener.refreshPage(1);
				        }
				    }

				    if (pageOption.toUpperCase() == 'CLOSE') {
					    closePage();
                    }
					else if (pageOption.toUpperCase() == 'CLEAR') {
						refreshPage(0,true);
					}
					else {
						refreshPage(id,true);
					}
				}
				else {
					MessageBox('Failed to save Task. \n' + errorMsg);
				}
			}
		    catch (e) {
		        alert("Error in Save_Done. " + e.message);
		    }
		}

		function on_error(result) {
			var resultText = 'An error occurred when communicating with the server';/*\n' +
					'readyState = ' + result.readyState + '\n' +
					'responseText = ' + result.responseText + '\n' +
					'status = ' + result.status + '\n' +
					'statusText = ' + result.statusText;*/

			MessageBox('save error:  \n' + resultText);
		}
	</script>

	<script id="jsInit" type="text/javascript">

		function initializeControls() {

			$('.pageContainer').css('background-color', '#FAFAFA');
			$(':input').css('font-family', 'Arial');
			$(':input').css('font-size', '12px');
			$('[name="FirstLabel"]').width(140);

			//date pickers
			$('#<%=this.txtStartDate_Planned.ClientID %>').datepicker();
			$('#<%=this.txtStartDate_Actual.ClientID %>').datepicker();
			$('#<%=this.txtEndDate_Actual.ClientID %>').datepicker();

			//html editor
			var w = '99%';// $('#<%=this.textAreaDescription.ClientID %>').width();
			var h = 150;
			if (($('#<%=this.textAreaDescription.ClientID %>').height() + 60) > 150) {
				h = $('#<%=this.textAreaDescription.ClientID %>').height() + 60;
			};

			$('#<%=this.txtTitle.ClientID %>').change(function () { txt_change(this); });
			$('input').change(function () { clearMessage(); });
			$('select').change(function () { clearMessage(); });

			$('#<%=this.textAreaDescription.ClientID %>').cleditor({ width: w, height: h });

			$('#<%=this.textAreaDescription.ClientID %>').cleditor()[0].change(function () { txt_change($('#<%=this.textAreaDescription.ClientID %>')); });
			$($('#<%=this.textAreaDescription.ClientID %>').cleditor()[0].doc).css('height', (h - 28) + 'px');
			$($('#<%=this.textAreaDescription.ClientID %>').cleditor()[0].doc.body).css('height', (h - 26) + 'px');
			$($('#<%=this.textAreaDescription.ClientID %>').cleditor()[0].doc.body).css('background-color', '#F5F6CE');

   		    $('#<%=this.imgEffortHelp.ClientID %>').click(function () { MessageBox('XS = 0-4 Hours,S = 4-8 Hours, M = 8-24 Hours, L = 24-40 Hours, XL = 41-80 Hours'); });


			if (!_canEdit) {
				$('#<%=this.textAreaDescription.ClientID %>').cleditor()[0].disable(true);
			}

		}

		function initializeEvents() {

			$(window).resize(resizePage);

			$('[id$="imgRefresh"]').click(function () { refreshPage(_taskID, false); return false; });
			$('#buttonHistory').click(function () { buttonHistory_click(); return false; });
			$('#<%=this.buttonSave.ClientID %>').click(function () { buttonSave_click(''); return false; });
			$('#buttonSaveAndClose').click(function () { buttonSave_click('close'); return false; });
			$('#buttonSaveAndClear').click(function () { buttonSave_click('clear'); return false; });
			$('#buttonClose').click(function () { buttonClose_click(); return false; });
			$('#aEdit').click(function () { aEdit_click(); return false; });

			$('.hideSection').click(function (event) {
				showHideSection_click($(this).attr('id'), false, $(this).attr('sectionName'));
			});
			$('.showSection').click(function (event) {
				showHideSection_click($(this).attr('id'), true, $(this).attr('sectionName'));
			});

			$(document.body).bind('onbeforeunload', function () { closePage(); });
		}

		function initializeSections() {
			try {
				if (_taskID != 0) {
					loadComments();
					loadAttachments();
					$('#imgShowComments').trigger('click');
				}
				else {
					$('#imgShowComments').unbind('click');
					$('#divCommentsContainer').hide();
				}

				return;
			} catch (e) {

			}
		}

		$(document).ready(function () {
			_pageUrls = new PageURLs();
			_taskID = parseInt('<%=this.WorkItem_TaskID %>');
			_workItemID = parseInt('<%=this.WorkItemID %>');
			if ('<%=this.CanEdit.ToString().ToUpper() %>' == 'TRUE') {
				_canEdit = true;
			}

		    if ('<%=this.IsNew.ToString().ToUpper() %>' != 'TRUE' && _canEdit && '<%=this.CanEditAOR %>'.toUpperCase() == 'TRUE') $('#aEdit').show();

			initializeControls();

			$('#divTabsContainer').tabs({
				heightStyle: "fill"
				, collapsible: false
				, active: 0
			});

			if ('<%=this.IsNew.ToString().ToUpper() %>' == 'TRUE') {
				$('#buttonHistory').hide();
				$('#buttonSaveAndClose').show();
				$('#buttonSaveAndClear').show();

				$("#divTabsContainer").tabs("option", "disabled", [1]);
			}
			
			initializeEvents();
			initializeSections();

			if ('<%=this.SaveComplete %>' == '1') {
				$('#labelMessage').text('Item updates have been saved.');
				$('#labelMessage').show();
			}
			else {
				clearMessage();
			}

			Tab_click('details');

			resizePage();

			$("#helpButton").click(function () {
			    clearMessage();

			    var title = '', url = '';
			    var h = 600, w = 1000;

			    title = 'Sub-Task Attributes';
			    url = _pageUrls.Maintenance.WorkItemDetailsHelp;

			    //open in a popup
			    var openPopup = popupManager.AddPopupWindow('Help', title, 'Loading.aspx?Page=' + url, h, w, 'PopupWindow', this);
			    if (openPopup) {
			        openPopup.Open();
			    }
			});
		});
	</script>

</asp:Content>