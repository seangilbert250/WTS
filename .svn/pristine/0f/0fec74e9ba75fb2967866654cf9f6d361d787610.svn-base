using System;
using System.Collections.Generic;
using System.Data;
using System.Xml;
using System.Web.Services;
using System.Web.UI.WebControls;

using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

using WTS;

public partial class RQMTBuilder : WTSContentPage
{
    #region Variables
    protected bool CanEditRQMT = false;
    protected bool CanViewRQMT = false;
    protected string Title = string.Empty;
    protected string Type = string.Empty;
    protected string DescriptionTypeOptions = string.Empty;
    private DataColumnCollection DCC;
    protected string DefaultRQMTSystemIDs = string.Empty;
    protected int DefaultRQMTSet_RQMTSystemID = 0;
    protected int DefaultSystemSuiteID = 0;
    protected int DefaultSystemID = 0;
    protected int DefaultWorkAreaID = 0;
    protected int DefaultRQMTTypeID = 0;
    protected int DefaultRQMTID = 0;

    protected string CustomLists = string.Empty;

    protected string ComplexityOptions = string.Empty;
    protected string SuiteOptions = string.Empty;
    protected string SystemOptions = string.Empty;
    protected string WorkAreaOptions = string.Empty;
    protected string RQMTTypeOptions = string.Empty;
    protected string FunctionalitySelectOptions = string.Empty;
    protected string FunctionalityCheckBoxOptions = string.Empty;

    protected Dictionary<string, string> AttributeOptions;

    #endregion

    #region Page
    private void Page_Load(object sender, EventArgs e)
    {
        ReadQueryString();
        InitializeEvents();

        this.CanEditRQMT = UserManagement.UserCanEdit(WTSModuleOption.RQMT);
        this.CanViewRQMT = this.CanEditRQMT || UserManagement.UserCanView(WTSModuleOption.RQMT);

        switch (this.Type)
        {
            case "Add":
            case "Edit":
                this.Title = "Add/Edit a Requirement Set";
                break;
        }

        LoadControls();

        CustomLists = FillCustomLists();
    }

    private void ReadQueryString()
    {
        if (Request.QueryString["Type"] != null && !string.IsNullOrWhiteSpace(Request.QueryString["Type"]))
        {
            this.Type = Request.QueryString["Type"];
        }

        Int32.TryParse(Request.QueryString["SystemSuiteID"], out DefaultSystemSuiteID);
        Int32.TryParse(Request.QueryString["WTS_SYSTEMID"], out DefaultSystemID);
        Int32.TryParse(Request.QueryString["WorkAreaID"], out DefaultWorkAreaID);
        Int32.TryParse(Request.QueryString["RQMTTypeID"], out DefaultRQMTTypeID);
        Int32.TryParse(Request.QueryString["RQMTSetRQMTSystemID"], out DefaultRQMTSet_RQMTSystemID);
        Int32.TryParse(Request.QueryString["RQMTID"], out DefaultRQMTID);

        if (DefaultSystemSuiteID == 0 && DefaultSystemID != 0)
        {
            DataTable dt = MasterData.WorkArea_SystemList_Get(DefaultWorkAreaID, DefaultSystemID);
            if (dt.Rows.Count > 0)
            {
                foreach (DataRow row in dt.Rows)
                {
                    int wasysid = (int)row["WorkArea_SystemID"];

                    if (wasysid != 0)
                    {
                        DefaultSystemSuiteID = (int)row["WTS_SYSTEM_SUITEID"];

                        break;
                    }
                }
            }
        }
        else if (DefaultRQMTSet_RQMTSystemID != 0)
        {
            // note, this data set contains the following tables:
            // [0] = RQMT
            // [1] = DESC
            // [2] = FUNC
            DataSet ds = RQMT.RQMTSet_RQMTList_Get(0, null, 0, 0, 0, DefaultRQMTSet_RQMTSystemID);

            if (ds.Tables.Count > 0 && ds.Tables["RQMT"].Rows.Count > 0)
            {
                DataRow row = ds.Tables["RQMT"].Rows[0];

                DefaultSystemID = (int)row["WTS_SYSTEMID"];
                DefaultWorkAreaID = (int)row["WorkAreaID"];
                DefaultSystemSuiteID = (int)row["WTS_SYSTEM_SUITEID"];
                DefaultRQMTTypeID = (int)row["RQMTTypeID"];
            }
        }
    }

    private void InitializeEvents()
    {

    }
    #endregion

    #region Data
    private void LoadControls()
    {
        // suites ddl
        DataTable dtSuites = MasterData.SystemSuiteList_Get(0);
        PopulateDDLFromDataTable(ddlSuite, dtSuites, "WTS_SYSTEM_SUITEID", "WTS_SYSTEM_SUITE", null, null, false);
        SuiteOptions = CreateOptionStringFromDataTable(dtSuites, "WTS_SYSTEM_SUITEID", "WTS_SYSTEM_SUITE", "0", "", true);

        // systems
        DataTable dtSystems = MasterData.SystemList_Get(includeArchive: true, WTS_SYSTEM_SUITEID: 0);
        SystemOptions = CreateOptionStringFromDataTable(dtSystems, "WTS_SYSTEMID", "WTS_SYSTEM", "0", "", true);

        // workarea ddl
        DataTable dtWorkAreas = MasterData.WorkAreaList_Get();
        WorkAreaOptions = CreateOptionStringFromDataTable(dtWorkAreas, "WorkAreaID", "WorkArea", "0", "", true);

        // RQMTType ddl (purpose)
        DataTable dtTypes = RQMT.RQMTTypeList_Get();
        PopulateDDLFromDataTable(ddlRQMTType, dtTypes, "RQMTTypeID", "RQMTType", null, null, false, "InternalType");        
        RQMTTypeOptions = CreateOptionStringFromDataTable(dtTypes, "RQMTTypeID", "RQMTType", "0", "", true, "InternalType");

        // Description Types option list
        DataTable dtDescTypes = RQMT.RQMTDescriptionTypeList_Get();
        DescriptionTypeOptions = CreateOptionStringFromDataTable(dtDescTypes, "RQMTDescriptionTypeID", "RQMTDescriptionType", null, null, true);

        // RQMTComplexity
        DataTable dtComplexity = RQMT.RQMTComplexityList_Get();
        ComplexityOptions = CreateOptionStringFromDataTable(dtComplexity, "RQMTComplexityID", "RQMTComplexity", null, null, true);

        // Functionality
        DataTable dtFunctionality = MasterData.WorkloadGroupList_Get();
        FunctionalitySelectOptions = CreateOptionStringFromDataTable(dtFunctionality, "WorkloadGroupID", "WorkloadGroup", "0", "", true, null);
        FunctionalityCheckBoxOptions = CreateCheckBoxStringFromDataTable(dtFunctionality, "WorkloadGroupID", "WorkloadGroup", true, 1, null);

        // Attributes
        AttributeOptions = new Dictionary<string, string>();

        DataTable dtStage = RQMT.RQMTAttribute_Get((int)WTS.Enums.RQMTAttributeTypeEnum.Stage);
        AttributeOptions["stage"] = CreateOptionStringFromDataTable(dtStage, "RQMTAttributeID", "RQMTAttribute", "0", "", true);

        DataTable dtCrit = RQMT.RQMTAttribute_Get((int)WTS.Enums.RQMTAttributeTypeEnum.Criticality);
        AttributeOptions["criticality"] = CreateOptionStringFromDataTable(dtCrit, "RQMTAttributeID", "RQMTAttribute", "0", "", true);

        DataTable dtStatus = RQMT.RQMTAttribute_Get((int)WTS.Enums.RQMTAttributeTypeEnum.Status);
        AttributeOptions["status"] = CreateOptionStringFromDataTable(dtStatus, "RQMTAttributeID", "RQMTAttribute", "0", "", true);
    }

    private DataTable LoadData()
    {
        DataTable dt = new DataTable();

        return dt;
    }
    #endregion

    #region AJAX

    [WebMethod()]
    public static string GetSystemsForSuite(string suiteID)
    {
        DataTable dt = new DataTable();

        int sid = 0;
        if (Int32.TryParse(suiteID, out sid))
        {
            dt = MasterData.SystemList_Get(includeArchive: true, WTS_SYSTEM_SUITEID: sid);
        }

        return JsonConvert.SerializeObject(dt, Newtonsoft.Json.Formatting.None);
    }

    [WebMethod()]
    public static string GetWorkAreasForSystems(string systemIDs)
    {
        DataTable dt = new DataTable();

        dt = MasterData.WorkAreaList_Get(includeArchive: false, cv: "0", systemIDs: systemIDs);

        return JsonConvert.SerializeObject(dt, Newtonsoft.Json.Formatting.None);
    }

    [WebMethod()]
    public static string GetRequirementTypes()
    {
        DataTable dtTypes = RQMT.RQMTTypeList_Get();

        return WTSPage.SerializeResult(dtTypes);
    }

    [WebMethod()]
    public static string FillCustomLists()
    {
        Dictionary<string, object> results = new Dictionary<string, object>();

        // functional rqmt priority
        DataTable dt = MasterData.PriorityList_Get(false, false, (int)WTS.Enums.PriorityTypeEnum.RQMT);
        dt.Columns.Add("Default");
        foreach (DataRow row in dt.Rows)
        {
            row["Default"] = row["Priority"].ToString() == "Major" ? "true" : "false";
        }
        dt.AcceptChanges();
        results["RQMTPriority"] = dt;

        return WTSPage.SerializeResult(results);
    }

    [WebMethod()]
    public static string FilterRQMTSets(int RQMTSetID, string RQMTSetName, int WTS_SYSTEMID, int WorkAreaID, int RQMTTypeID)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMTSetID < 0)
        {
            RQMTSetID = 0;
        }

        // note, this data set contains the following tables:
        // [0] = RQMT
        // [1] = DESC
        // [2] = FUNC
        DataSet ds = RQMT.RQMTSet_RQMTList_Get(RQMTSetID, !string.IsNullOrWhiteSpace(RQMTSetName) ? RQMTSetName : null, WTS_SYSTEMID, WorkAreaID, RQMTTypeID, 0);

        return WTSPage.SerializeResult(ds);
    }

    [WebMethod()]
    public static string AddRQMTSet(string RQMTSetName, int WTS_SYSTEMID, int WorkAreaID, int RQMTTypeID)
    {
        var result = WTSPage.CreateDefaultResult();

        var RQMTSetID = RQMT.RQMTSet_Save(0, RQMTSetName, WTS_SYSTEMID, WorkAreaID, RQMTTypeID, 0, null);

        if (RQMTSetID > 0)
        {
            result["success"] = "true";
        }

        result["RQMTSetID"] = RQMTSetID.ToString();

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string SaveRQMTSet(int RQMTSetID, string RQMTSetName, int WTS_SYSTEMID, int WorkAreaID, int RQMTTypeID, int RQMTComplexityID, string justification)
    {
        var result = WTSPage.CreateDefaultResult();

        var postSaveRQMTSetID = RQMT.RQMTSet_Save(RQMTSetID, string.IsNullOrWhiteSpace(RQMTSetName) ? "" : RQMTSetName, WTS_SYSTEMID, WorkAreaID, RQMTTypeID, RQMTComplexityID, justification);

        if (postSaveRQMTSetID == RQMTSetID)
        {
            result["success"] = "true";
        }
        else
        {
            result["exists"] = "true";
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string ExecuteComponentSearch(string compType, string txt)
    {
        DataTable dt = new DataTable();

        bool returnAll = txt == "[ALL]";

        if (txt != null && txt.Length > 100)
        {
            txt = txt.Substring(0, 100);
        }

        switch (compType)
        {
            case "rqmt":
                if (string.IsNullOrWhiteSpace(txt))
                {
                    txt = "[NONE]"; // we don't allow blank searches for rqmts
                }
                dt = RQMT.RQMTList_Get(0, txt, true);
                break;
            case "type":
                dt = RQMT.RQMTTypeList_Get(returnAll || string.IsNullOrWhiteSpace(txt) ? null : txt); // the type list is short so we default to showing all
                break;
            case "workarea":
                dt = MasterData.WorkAreaList_Get();
                if (!string.IsNullOrWhiteSpace(txt))
                {
                    txt = txt.ToUpper();
                    foreach (DataRow row in dt.Rows)
                    {
                        if (row["WorkArea"].ToString().ToUpper().IndexOf(txt) == -1)
                        {
                            row.Delete();
                        }
                    }
                }
                break;
            case "sys":
                dt = MasterData.SystemList_Get();
                DataColumn col = dt.Columns["WTS_SystemID"];
                col.ColumnName = "WTS_SYSTEMID";

                if (!string.IsNullOrWhiteSpace(txt))
                {
                    txt = txt.ToUpper();
                    foreach (DataRow row in dt.Rows)
                    {
                        if (row["WTS_SYSTEM"].ToString().ToUpper().IndexOf(txt) == -1)
                        {
                            row.Delete();
                        }
                    }
                }
                break;
            case "desc":
                if (string.IsNullOrWhiteSpace(txt))
                {
                    txt = "__NONE__"; // we don't allow blank searches for descriptions
                }
                dt = RQMT.RQMTBuilderDescriptionList_Get(0, txt, false);
                break;
        }

        // some of the source queries are returning invalid xml/json column names, so we fix the common errors
        foreach (DataColumn x in dt.Columns)
        {
            x.ColumnName = x.ColumnName.Replace(" ", "_").Replace("#", "NUM");
        }
        dt.AcceptChanges();

        string str = WTSPage.SerializeResult(dt);

        return WTSPage.SerializeResult(dt);
    }

    [WebMethod()]
    public static string AddRQMTToRQMTSet(int RQMTSetID, int RQMTID, string RQMTText)
    {
        var result = WTSPage.CreateDefaultResult();

        try
        {
            RQMTID = RQMT.RQMTSet_AddRQMT(RQMTSetID, RQMTID, RQMTText);

            result["success"] = "true";
            result["RQMTID"] = RQMTID.ToString(); // only needed if we create a brand new RQMTID
        }
        catch (Exception e)
        {
            result["error"] = e.Message;
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string CreateNewComponent(string compType, string txt)
    {
        var result = WTSPage.CreateDefaultResult();

        try
        {
            if (compType == "rqmt")
            {
                var saveResult = RQMT.RQMT_Save(true, 0, txt);

                result["success"] = saveResult["saved"].ToLower();
                result["rqmtid"] = saveResult["newID"];
            }
        }
        catch (Exception e)
        {
            result["error"] = e.Message;
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string SaveRQMTBase(int RQMTID, string txt)
    {
        var result = WTSPage.CreateDefaultResult();

        var saveResult = RQMT.RQMT_Save(false, RQMTID, txt);

        result["success"] = saveResult["saved"].ToLower();
        result["exists"] = saveResult["exists"].ToLower();

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string DeleteRQMTBase(int RQMTID)
    {
        var result = WTSPage.CreateDefaultResult();

        var deleteResult = RQMT.RQMT_Delete(RQMTID, false);

        result["success"] = deleteResult["deleted"];
        result["hasdependencies"] = deleteResult["hasdependencies"];

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string DeleteRQMTFromSet(int RQMTSetID, int RQMTID)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTSet_DeleteRQMT(RQMTSetID, RQMTID, 0, true))
        {
            result["success"] = "true";
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string DeleteRQMTSet(int RQMTSetID)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTSet_Delete(RQMTSetID))
        {
            result["success"] = "true";
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string GetRQMTSetNames()
    {
        return WTSPage.SerializeResult(RQMT.RQMTSetName_Get());
    }

    [WebMethod()]
    public static string RenameRQMTSetGroup(int RQMTSetNameID, string name)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTSetName_Save(RQMTSetNameID, name))
        {
            result["success"] = "true";
        }
        else
        {
            result["error"] = "Name already exists and could not be changed.";
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string SaveRQMTSetOrdering(string order)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTSet_ReorderRQMTs(0, order))
        {
            result["success"] = "true";
        }
        
        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string LoadAllRQMTSets()
    {
        return WTSPage.SerializeResult(RQMT.RQMTSetList_Get());
    }

    [WebMethod()]
    public static string LoadAllRQMTSetsForRQMT(int RQMTID)
    {
        return WTSPage.SerializeResult(RQMT.RQMT_AssociatedSets_Get(RQMTID));
    }

    [WebMethod()]
    public static string SaveRQMTChanges(string changes)
    {
        var result = WTSPage.CreateDefaultResult();

        try
        {
            JObject jobj = (JObject)JsonConvert.DeserializeObject(changes);

            int RQMTID = 0;
            string addToSets = "";
            string deleteFromSets = "";
            string RQMTText = "";

            foreach (KeyValuePair<string, JToken> token in (JObject)jobj)
            {
                string value = token.Value.ToString();

                if (token.Key == "RQMTID")
                {
                    RQMTID = Int32.Parse(value);
                }
                else if (token.Key == "adds")
                {
                    addToSets = value;
                }
                else if (token.Key == "deletes")
                {
                    deleteFromSets = value;
                }
                else if (token.Key == "RQMT")
                {
                    RQMTText = value;
                }
            }

            if (RQMT.RQMTBuilder_RQMTUpdate(RQMTID, RQMTText, addToSets, deleteFromSets))
            {
                result["success"] = "true";
            }
        }
        catch (Exception e)
        {
            result["error"] = e.Message;
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string SaveRQMTDescription(int RQMTSet_RQMTSystemID, int RQMTSystemRQMTDescriptionID, string RQMTDescription, int RQMTDescriptionTypeID, bool editMode)
    {
        var result = WTSPage.CreateDefaultResult();

        try
        {
            int RQMTDescriptionID = RQMT.RQMTSystem_SaveDescription(RQMTSet_RQMTSystemID, RQMTSystemRQMTDescriptionID, RQMTDescription, RQMTDescriptionTypeID, editMode);

            result["success"] = "true";
            result["rqmtdescriptionid"] = RQMTDescriptionID.ToString();
        }
        catch (Exception e)
        {
            if (e.Message.IndexOf("UNIQUE KEY") != -1)
            {
                result["error"] = "This description/type combination already exists in this RQMT.";
            }
            else
            {
                result["error"] = e.Message;
            }
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string DeleteRQMTDescription(int RQMTSystemRQMTDescriptionID)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTSystem_DeleteDescription(RQMTSystemRQMTDescriptionID))
        {
            result["success"] = "true";
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string SaveRQMTAttributes(int RQMTSet_RQMTSystemID, int RQMTStageID, int CriticalityID, int RQMTStatusID, bool RQMTAccepted)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTSystemAttributes_Save(RQMTSet_RQMTSystemID, RQMTStageID, CriticalityID, RQMTStatusID, RQMTAccepted))
        {
            result["success"] = "true";
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string SaveRQMTFunctionality(int RQMTSetID, int RQMTSet_RQMTSystemID, string RQMTFunctionalities, int RQMTSetFunctionalityID, int FunctionalityID, int ComplexityID, string Justification)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTFunctionality_Save(RQMTSetID, RQMTSet_RQMTSystemID, RQMTFunctionalities, RQMTSetFunctionalityID, FunctionalityID, ComplexityID, Justification))
        {
            result["success"] = "true";
            result["RQMTSetID"] = RQMTSetID.ToString();
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string DeleteRQMTFunctionality(int RQMTSetID, int RQMTSet_RQMTSystemID, int RQMTSetFunctionalityID)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTFunctionality_Delete(RQMTSetID, RQMTSet_RQMTSystemID, RQMTSetFunctionalityID))
        {
            result["success"] = "true";
        }

        return WTSPage.SerializeResult(result);
    }

    [WebMethod()]
    public static string UpdateRQMTSetRQMTSystemUsage(int RQMTSet_RQMTSystemID, int month, bool selected)
    {
        var result = WTSPage.CreateDefaultResult();

        if (RQMT.RQMTSet_RQMTSystem_Usage_Update(RQMTSet_RQMTSystemID, month, selected))
        {
            result["success"] = "true";
        }

        return WTSPage.SerializeResult(result);
    }

    #endregion
}