using System;
using System.Collections.Generic;
using System.Data;
using System.Web;
using System.Web.Services;
using System.Web.UI;
using System.Web.UI.WebControls;
using Newtonsoft.Json;
using System.Xml;

public partial class CrosswalkParamContainer : System.Web.UI.Page
{
	protected string Grid_View = string.Empty;
	protected string RollupGroup = "Status";
	protected string DefaultSortType = "Tech";
	protected int ActiveTab = 0;
    protected string ddlChanged_ML = "no";

    protected void Page_Load(object sender, EventArgs e)
	{
		readQueryString();

		loadLookupData();

        if (Session["Crosswalk_GridView_ML"] != null) Session["Crosswalk_GridView_ML"] = ddlView.SelectedItem.ToString();
        else Session["Crosswalk_GridView_ML"] = WTSData.GetDefaultGridViewName(10, UserManagement.GetUserId_FromUsername());

        if (Session["CurrentXML"] != null)
        { 
            txtXML.Value = Session["CurrentXML"].ToString();
        }
        else
        {
            txtXML.Value = "";
        }
    }

    private void readQueryString()
	{
        #region Grid View

        if (Request.QueryString["ddlChanged_ML"] != null)
        {
            ddlChanged_ML = Request.QueryString["ddlChanged_ML"].ToString();
        }


        if (Session["Crosswalk_GridView_ML"] != null && !string.IsNullOrWhiteSpace(Session["Crosswalk_GridView_ML"].ToString()))
		{
			this.Grid_View = Session["Crosswalk_GridView_ML"].ToString();
		}
		else
		{
			if (Request.QueryString["gridView"] != null
				&& !string.IsNullOrWhiteSpace(Request.QueryString["gridView"].ToString()))
			{
				this.Grid_View = Server.UrlDecode(Request.QueryString["gridView"]).Replace("?", "");
			}
			else
			{
				this.Grid_View = string.Empty;
			}
			Session["Crosswalk_GridView_ML"] = this.Grid_View;
		}

		#endregion Grid View


        // 11626 - 2 > Read user preference. SCB TODO - Get this added to My Profile and hook them up.
        if (Session["defaultCrosswalkGrid_ML"] != null && !string.IsNullOrWhiteSpace(Session["defaultCrosswalkGrid_ML"].ToString()))
        { 
            this.DefaultSortType = Session["defaultCrosswalkGrid_ML"].ToString();
        }
        else
        {
            this.DefaultSortType = "Tech";
        }


        if (Request.QueryString["Tab"] != null
			&& !string.IsNullOrWhiteSpace(Request.QueryString["Tab"].ToString()))
		{
			int.TryParse(Server.UrlDecode(Request.QueryString["Tab"].ToString()), out this.ActiveTab);
		}
	}

	private void loadLookupData()
	{
		int UserId = UserManagement.GetUserId_FromUsername();
		WTS_User u = new WTS_User(UserId);
		u.Load();
		DataTable dt = WTSData.GetViewOptions(userId: UserId, gridName: "Workload Crosswalk");
		DataTable dtSetting = u.UserSettingList_Get(u.ID, (int)UserSettingType.GridView, (int)WTSGridName.Workload_Crosswalk);

		if (dt != null && dt.Rows.Count > 0)
		{
			ddlView.Items.Clear();

			ListItem item = null;
			foreach (DataRow row in dt.Rows)
			{
				item = new ListItem();
				item.Text = row["ViewName"].ToString();
				item.Value = row["GridViewID"].ToString();
				item.Attributes.Add("OptionGroup", row["WTS_RESOURCEID"].ToString() != "" ? "Custom Views" : "Process Views");
				item.Attributes.Add("MyView", row["MyView"].ToString());
				item.Attributes.Add("Tier1RollupGroup", row["Tier1RollupGroup"].ToString());
				item.Attributes.Add("Tier1ColumnOrder", row["Tier1ColumnOrder"].ToString());
				item.Attributes.Add("Tier2ColumnOrder", row["Tier2ColumnOrder"].ToString());
				item.Attributes.Add("DefaultSortType", row["Tier2SortOrder"].ToString());
                item.Attributes.Add("SectionsXML", row["SectionsXML"].ToString());

                // Set the default, over-write below if user has saved a view preference.
                if (item.Text.ToString().ToLower() == "default")
                {
                    if (row["SectionsXML"].ToString() != "")
                    {
                        XmlDocument xml = new XmlDocument();
                        xml.LoadXml(row["SectionsXML"].ToString());

                        HttpContext.Current.Session["Levels"] = xml;
                        //------------------------------------------
                    }
                }

                ddlView.Items.Add(item);

                try
                {
                    if (Session["defaultCrosswalkGrid_ML"] != null)
                    {
                        if (ddlView.Items.FindByText(row["ViewName"].ToString()) == null)
                        {
                            // If user has saved view preference, save that XML to Session.
                            if (Session["defaultCrosswalkGrid_ML"].ToString().ToLower() == item.Text.ToString().ToLower())
                            {
                                if (row["SectionsXML"].ToString() != "")
                                {
                                    XmlDocument xml = new XmlDocument();
                                    xml.LoadXml(row["SectionsXML"].ToString());

                                    HttpContext.Current.Session["Levels"] = xml;
                                    //------------------------------------------
                                }
                            }
                        }
                    }
                }
                catch (Exception)
                {
                    // Nothing to do here, will use default.
                }
            }

            // 11626 - 2 > Use saved preferences:
            if (Session["defaultCrosswalkGrid_ML"] != null && !string.IsNullOrWhiteSpace(Session["defaultCrosswalkGrid_ML"].ToString()) && ddlChanged_ML != "yes")
                {
                ListItem itemGridView = ddlView.Items.FindByText(Session["defaultCrosswalkGrid_ML"].ToString());
                if (itemGridView != null)
                {
                    itemGridView.Selected = true;
                }
                else
                {
                    this.Grid_View = string.Empty;
                }
            }
            else  // No saved view preference
            {
                if (!string.IsNullOrWhiteSpace(this.Grid_View))
                {
                    ListItem itemGridView = ddlView.Items.FindByText(this.Grid_View);
                    if (itemGridView != null)
                    {
                        itemGridView.Selected = true;
                    }
                    else
                    {
                        this.Grid_View = string.Empty;
                    }
                }
                else
                {
                    if (dtSetting != null && dtSetting.Rows.Count > 0)
                    {
                        WTSUtility.SelectDdlItem(ddlView, dtSetting.Rows[0]["SettingValue"].ToString().Trim());
                    }
                }
            }

            if (Session["CurrentDropDown"] != null)
            { 
                // Not working, may be because of "Process Views" "Custom Views"
                //ddlView.SelectedIndex = Convert.ToInt32(Session["CurrentDropDown"].ToString()); 
            }

            if (Session["Levels"] != null)  // HttpContext.Current.
            {
                Page.ClientScript.RegisterArrayDeclaration("dtSectionsView", JsonConvert.SerializeObject(dt, Newtonsoft.Json.Formatting.None));
            }
        }
    }

    [WebMethod(true)]
	public static string SaveView(string gridView, string gridViewName, int processView
        , string SectionsXML)
	{
		Dictionary<string, string> result = new Dictionary<string, string>() { { "saved", "false" }, { "error", "" } };
		bool saved = false;
		string errorMsg = string.Empty;

		try
		{
            int gridViewID = 0;
			int.TryParse(gridView, out gridViewID);
			GridView gv = new GridView();

            XmlDocument xmlLevels = new XmlDocument();
            xmlLevels.LoadXml(SectionsXML);

            gv.GridNameID = (int)WTSGridName.Workload_Crosswalk;
			gv.ID = gridViewID;
			gv.Name = gridViewName;
			gv.UserID = (processView == 1 ? 0 : UserManagement.GetUserId_FromUsername());
            gv.Tier1Columns = "";
            gv.Tier1ColumnOrder = "";
            gv.Tier2Columns = "";
            gv.Tier2SortOrder = "";            

            gv.SectionsXML = xmlLevels; 

            saved = gv.Save(out errorMsg);  // This checks for existing row and does either Add or Update.

			if (saved)
			{
				HttpContext.Current.Session["Crosswalk_GridView_ML"] = gridViewName;
                HttpContext.Current.Session["CurrentXML"] = "";
                HttpContext.Current.Session["CurrentDropDown"] = "";

                if (SectionsXML != null)
                {
                    HttpContext.Current.Session["Levels"] = xmlLevels;
                }
            }
        }
        catch (Exception ex)
		{
			LogUtility.LogException(ex);
			saved = false;
		}

		result["saved"] = saved.ToString();
		result["error"] = errorMsg;

		return JsonConvert.SerializeObject(result, Newtonsoft.Json.Formatting.None);
	}

    //SaveDefaultXML

    [WebMethod(true)]
    public static void SaveDefaultXML(string currentXML, string ddlIndex, string ddlText)
    {
        var sessionMethods = new SessionMethods();

        sessionMethods.Session["CurrentXML"] = currentXML;
        sessionMethods.Session["CurrentDropDown"] = ddlIndex;
        sessionMethods.Session["Crosswalk_GridView_ML"] = ddlText;
        sessionMethods.Session["defaultCrosswalkGrid_ML"] = ddlText;
    }

    [WebMethod(true)]
	public static string DeleteView(string gridView)
	{
		Dictionary<string, string> result = new Dictionary<string, string>() { { "saved", "false" }, { "error", "" } };
		bool saved = false, exists = false;
		string errorMsg = string.Empty;

		try
		{
			int gridViewID = 0;
			int.TryParse(gridView, out gridViewID);

			if (gridViewID > 0)
			{
				GridView gv = new GridView(gridViewID);
				saved = gv.Delete(out exists, out errorMsg);
			}
		}
		catch (Exception ex)
		{
			LogUtility.LogException(ex);
			saved = false;
		}

		result["saved"] = saved.ToString();
		result["error"] = errorMsg;

		return JsonConvert.SerializeObject(result, Newtonsoft.Json.Formatting.None);
	}

    [WebMethod(true)]
    public static void UpdateSession(String sLevels)
    {
        XmlDocument xmlLevels = new XmlDocument();
        xmlLevels.LoadXml(sLevels);

        Page objp = new Page();
        objp.Session["Levels"] = xmlLevels;
    }

}